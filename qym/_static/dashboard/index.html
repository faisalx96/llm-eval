<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>qym • Analytics</title>
  <link rel="icon" type="image/png" href="./static/qym_icon.png">
  <link rel="stylesheet" href="./static/dashboard.css">
</head>
<body>
  <!-- Toast Notifications -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Top Stats Bar -->
  <header class="stats-bar">
    <div class="logo">
      <img src="./static/qym_text.png" alt="qym" class="logo-text-img" />
    </div>
    <div class="stat-cells">
      <div class="stat-cell">
        <span class="stat-label">RUNS</span>
        <span class="stat-value" id="total-runs">—</span>
      </div>
      <div class="stat-cell">
        <span class="stat-label">TASKS</span>
        <span class="stat-value" id="total-tasks">—</span>
      </div>
      <div class="stat-cell">
        <span class="stat-label">MODELS</span>
        <span class="stat-value" id="total-models">—</span>
      </div>
      <div class="stat-cell">
        <span class="stat-label">AVG SUCCESS</span>
        <span class="stat-value" id="avg-success">—</span>
      </div>
      <div class="stat-cell">
        <span class="stat-label">ITEMS EVAL'D</span>
        <span class="stat-value" id="total-items">—</span>
      </div>
      <div class="stat-cell trend">
        <span class="stat-label">7-DAY TREND</span>
        <div class="trend-chart" id="weekly-trend"></div>
      </div>
    </div>
    <div class="header-meta">
      <span id="last-updated">—</span>
      <span class="kbd">?</span> help
    </div>
  </header>

  <!-- Command Bar -->
  <div class="command-bar">
    <div class="search-box">
      <span class="search-icon">⌕</span>
      <input type="text" id="search" placeholder="Filter: task, model, dataset, or run ID..." />
      <span class="kbd">/</span>
    </div>
    <div class="view-toggle">
      <button class="view-toggle-btn active" data-view="charts">
        <span class="view-icon">◩</span>
        <span class="view-label">Charts</span>
      </button>
      <button class="view-toggle-btn" data-view="table">
        <span class="view-icon">▤</span>
        <span class="view-label">Runs</span>
      </button>
      <button class="view-toggle-btn" data-view="models">
        <span class="view-icon">⊞</span>
        <span class="view-label">Models</span>
      </button>
    </div>
    <div class="quick-filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="today">Today</button>
      <button class="filter-btn" data-filter="week">7d</button>
    </div>
    <div class="filter-dropdowns">
      <select id="filter-task" class="filter-select">
        <option value="">All Tasks</option>
      </select>
      <select id="filter-dataset" class="filter-select">
        <option value="">All Datasets</option>
      </select>
      <div class="multi-select-wrapper" id="model-filter-wrapper">
        <button class="multi-select-btn" id="filter-model-btn">All Models</button>
        <div class="multi-select-dropdown" id="filter-model-dropdown"></div>
      </div>
      <select id="filter-publish-status" class="filter-select">
        <option value="">All Status</option>
        <option value="published">Published</option>
        <option value="unpublished">Unpublished</option>
      </select>
    </div>
  </div>

  <!-- Comparison Panel (hidden by default) -->
  <div class="compare-panel" id="compare-panel" style="display: none;">
    <div class="compare-header">
      <span>⊕ SELECTED <span id="compare-count">0</span> RUNS</span>
      <div class="compare-actions">
        <button id="compare-view" class="action-btn">Compare</button>
        <button id="langfuse-btn" class="action-btn" style="display:none;">View in Langfuse</button>
        <button id="publish-selected" class="action-btn primary">Publish</button>
        <button id="delete-selected" class="action-btn danger">Delete</button>
        <button id="compare-clear" class="action-btn secondary">Clear</button>
      </div>
    </div>
    <div class="compare-chips" id="compare-chips"></div>
  </div>

  <!-- Main Content -->
  <main>
    <div id="loading" class="loading">
      <img src="./static/qym_icon.png" alt="" class="loading-icon" />
      <span>Scanning qym_results/...</span>
    </div>
    
    <div id="empty" class="empty" style="display:none;">
      <div class="empty-state">
        <img src="./static/qym_text.png" alt="qym" class="empty-logo" />
        <h2>No evaluation runs found</h2>
        <p>Run an evaluation to populate this dashboard.</p>
        <code>qym --task-file my_task.py --task-function my_func \
  --dataset my-dataset --metrics exact_match</code>
      </div>
    </div>

    <!-- Charts View (Default) -->
    <div id="charts-view" class="charts-container" style="display:none;">
      <div class="charts-header">
        <div class="charts-title-row">
          <h2>Metrics by Task & Dataset</h2>
          <span class="charts-subtitle">Showing average metric scores across all items in matching runs</span>
        </div>
        <div class="charts-legend" id="charts-legend"></div>
      </div>
      <div class="charts-grid" id="charts-grid"></div>
    </div>

    <!-- Models Comparison View -->
    <div id="models-view" class="models-container" style="display:none;">
      <div class="models-header">
        <div class="models-title-row">
          <h2>Model Comparison</h2>
          <span class="models-subtitle">Compare model performance across K runs for the same task and dataset</span>
        </div>
        <div class="models-controls">
          <div class="models-filter-row">
            <label class="filter-label">Metric:</label>
            <select id="models-metric-select" class="filter-select">
              <option value="">Select a metric...</option>
            </select>
            <label class="filter-label">Runs per model:</label>
            <input type="number" id="models-k-input" class="filter-input-k" min="1" max="100" value="5" placeholder="5">
            <span class="models-threshold-inline" id="models-threshold-row" style="display:none;">
              <label class="filter-label">Pass ≥</label>
              <input type="range" id="models-threshold-slider" class="threshold-slider-inline" min="0" max="100" step="5" value="80">
              <span class="threshold-value" id="models-threshold-value">80%</span>
              <span class="stat-info-icon threshold-info">i<span class="stat-info-tooltip">Score threshold for Pass@K and Pass^K metrics. Items scoring at or above this threshold are considered "correct".</span></span>
            </span>
          </div>
        </div>
      </div>
      <div class="models-empty" id="models-empty" style="display:none;">
        <div class="empty-icon">⊞</div>
        <h3>Select a Task and Dataset</h3>
        <p>Use the filters above to select a task and dataset to compare models</p>
      </div>
      <div class="models-grid" id="models-grid"></div>
      <div class="models-ranking" id="models-ranking" style="display:none;"></div>
    </div>

    <!-- Table View -->
    <div id="table-view" class="table-container" style="display:none;">
      <table class="runs-table">
        <thead>
          <tr id="table-header-row">
            <th class="col-select">
              <label class="custom-checkbox">
                <input type="checkbox" id="select-all" title="Select all"/>
                <span class="checkmark"></span>
              </label>
            </th>
            <th class="col-run sortable" data-sort="run">RUN ID</th>
            <th class="col-task sortable" data-sort="task">TASK</th>
            <th class="col-model sortable" data-sort="model">MODEL</th>
            <th class="col-dataset sortable" data-sort="dataset">DATASET</th>
            <th class="col-success sortable" data-sort="success">SUCCESS</th>
            <th class="col-completed sortable" data-sort="completed">COMPLETED</th>
            <!-- Dynamic metric columns inserted here by JS -->
            <th class="col-latency sortable" data-sort="latency">LATENCY</th>
            <th class="col-time sortable" data-sort="time">TIME</th>
            <th class="col-actions"></th>
          </tr>
        </thead>
        <tbody id="runs-tbody"></tbody>
      </table>
    </div>

    <!-- Grid View -->
    <div id="grid-view" class="grid-container" style="display:none;"></div>

    <!-- Timeline View -->
    <div id="timeline-view" class="timeline-container" style="display:none;"></div>

  </main>

  <!-- Status Bar -->
  <footer class="status-bar">
    <div class="status-left">
      <span id="status-filter">Showing all runs</span>
      <span class="sep">|</span>
      <span id="status-selected">0 selected</span>
    </div>
    <div class="status-right">
      <span class="status-hint"><span class="kbd">j</span>/<span class="kbd">k</span> navigate</span>
      <span class="status-hint"><span class="kbd">x</span> select</span>
      <span class="status-hint"><span class="kbd">c</span> compare</span>
      <span class="status-hint"><span class="kbd">Enter</span> open</span>
    </div>
  </footer>

  <!-- Delete Confirmation Modal -->
  <div class="modal" id="delete-modal" style="display:none;">
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h2>Delete Run</h2>
        <button class="modal-close" onclick="document.getElementById('delete-modal').style.display='none'">×</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this run?</p>
        <p class="delete-run-name" id="delete-run-name"></p>
        <p class="warning-text">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('delete-modal').style.display='none'">Cancel</button>
        <button class="btn btn-danger" id="confirm-delete-btn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Publish to Confluence Modal -->
  <div class="modal" id="publish-modal" style="display:none;">
    <div class="modal-content modal-publish">
      <div class="modal-header">
        <h2>Publish to Confluence</h2>
        <button class="modal-close" onclick="document.getElementById('publish-modal').style.display='none'">×</button>
      </div>
      <div class="modal-body">
        <div class="publish-run-info" id="publish-run-info">
          <!-- Run info will be populated by JS -->
        </div>

        <div class="publish-form">
          <div class="form-group">
            <label for="publish-run-name">Run Name <span class="required">*</span></label>
            <input type="text" id="publish-run-name" class="form-input" placeholder="e.g., gpt-4o-241205-1430" />
            <span class="form-hint">Name for this run in Confluence (editable)</span>
          </div>

          <div class="form-group">
            <label for="publish-project">Project <span class="required">*</span></label>
            <select id="publish-project" class="form-select">
              <option value="">Select a project...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="publish-task">Task <span class="required">*</span></label>
            <div class="select-with-add">
              <select id="publish-task" class="form-select" disabled>
                <option value="">Select a task...</option>
              </select>
              <button type="button" class="btn-add" id="add-task-btn" title="Create new task" disabled>+</button>
            </div>
          </div>

          <div class="form-group">
            <label for="publish-user">Published By <span class="required">*</span></label>
            <div class="user-search-wrapper">
              <input type="text" id="publish-user-search" class="form-input" placeholder="Search users..." autocomplete="off" />
              <input type="hidden" id="publish-user" />
              <div class="user-dropdown" id="user-dropdown" style="display:none;"></div>
            </div>
          </div>

          <div class="form-group">
            <label for="publish-description">Description <span class="required">*</span></label>
            <textarea id="publish-description" class="form-textarea" rows="4" placeholder="Describe the purpose and results of this evaluation run..."></textarea>
            <span class="form-hint">Provide business context for this evaluation</span>
          </div>

          <div class="form-row">
            <div class="form-group half">
              <label>Branch</label>
              <input type="text" id="publish-branch" class="form-input" readonly />
            </div>
            <div class="form-group half">
              <label>Commit</label>
              <input type="text" id="publish-commit" class="form-input" readonly />
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('publish-modal').style.display='none'">Cancel</button>
        <button class="btn btn-primary" id="confirm-publish-btn">Publish</button>
      </div>
    </div>
  </div>

  <!-- Create Task Modal -->
  <div class="modal" id="create-task-modal" style="display:none;">
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h2>Create Task</h2>
        <button class="modal-close" onclick="document.getElementById('create-task-modal').style.display='none'">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="new-task-name">Task Name <span class="required">*</span></label>
          <input type="text" id="new-task-name" class="form-input" placeholder="e.g., Intent Classification" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('create-task-modal').style.display='none'">Cancel</button>
        <button class="btn btn-primary" id="confirm-create-task-btn">Create</button>
      </div>
    </div>
  </div>

  <!-- Aggregate Publish Modal (for multi-run publish) -->
  <div class="modal" id="aggregate-publish-modal" style="display:none;">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Publish Aggregate Results</h2>
        <button class="modal-close" onclick="document.getElementById('aggregate-publish-modal').style.display='none'">×</button>
      </div>
      <div class="modal-body">
        <!-- Validation errors (hidden by default) -->
        <div class="aggregate-validation-error" id="aggregate-validation-error" style="display:none;">
          <span class="error-icon">⚠️</span>
          <span class="error-message" id="aggregate-error-message"></span>
        </div>

        <!-- Run info summary -->
        <div class="aggregate-run-info" id="aggregate-run-info">
          <!-- Populated by JS -->
        </div>

        <!-- Threshold sliders for each metric -->
        <div class="aggregate-thresholds" id="aggregate-thresholds">
          <h3>Pass Thresholds</h3>
          <p class="threshold-hint">Set the threshold for each metric. A run passes if its score is ≥ the threshold.</p>
          <div class="threshold-sliders" id="threshold-sliders">
            <!-- Populated by JS for each metric -->
          </div>
        </div>

        <!-- Metrics preview -->
        <div class="aggregate-metrics-preview" id="aggregate-metrics-preview">
          <h3>Metrics Preview</h3>
          <p class="metrics-preview-hint">These aggregate metrics will be published:</p>
          <div class="metrics-preview-table" id="metrics-preview-table">
            <!-- Populated by JS -->
          </div>
          <div class="metrics-preview-loading" id="metrics-preview-loading" style="display:none;">
            <img src="./static/qym_icon.png" alt="" class="loading-icon-sm" />
            <span>Loading metrics...</span>
          </div>
        </div>

        <!-- Publish form -->
        <div class="publish-form">
          <div class="form-group">
            <label for="agg-publish-run-name">Run Name <span class="required">*</span></label>
            <input type="text" id="agg-publish-run-name" class="form-input" placeholder="e.g., gpt-4o-K5-241205-1430" />
            <span class="form-hint">Name for this aggregate result in Confluence</span>
          </div>

          <div class="form-group">
            <label for="agg-publish-project">Project <span class="required">*</span></label>
            <select id="agg-publish-project" class="form-select">
              <option value="">Select a project...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="agg-publish-task">Task <span class="required">*</span></label>
            <div class="select-with-add">
              <select id="agg-publish-task" class="form-select" disabled>
                <option value="">Select a task...</option>
              </select>
              <button type="button" class="btn-add" id="agg-add-task-btn" title="Create new task" disabled>+</button>
            </div>
          </div>

          <div class="form-group">
            <label for="agg-publish-user">Published By <span class="required">*</span></label>
            <div class="user-search-wrapper">
              <input type="text" id="agg-publish-user-search" class="form-input" placeholder="Search users..." autocomplete="off" />
              <input type="hidden" id="agg-publish-user" />
              <div class="user-dropdown" id="agg-user-dropdown" style="display:none;"></div>
            </div>
          </div>

          <div class="form-group">
            <label for="agg-publish-description">Description <span class="required">*</span></label>
            <textarea id="agg-publish-description" class="form-textarea" rows="3" placeholder="Describe the purpose of this aggregate evaluation..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group half">
              <label>Branch</label>
              <input type="text" id="agg-publish-branch" class="form-input" readonly />
            </div>
            <div class="form-group half">
              <label>Commit</label>
              <input type="text" id="agg-publish-commit" class="form-input" readonly />
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('aggregate-publish-modal').style.display='none'">Cancel</button>
        <button class="btn btn-primary" id="confirm-aggregate-publish-btn">Publish K Runs</button>
      </div>
    </div>
  </div>

  <!-- Run Selection Modal (for Models view) -->
  <div class="modal" id="run-selection-modal" style="display:none;">
    <div class="modal-content modal-medium">
      <div class="modal-header">
        <h2>Select Runs for <span id="run-selection-model-name"></span></h2>
        <button class="modal-close" onclick="document.getElementById('run-selection-modal').style.display='none'">×</button>
      </div>
      <div class="modal-body">
        <p class="modal-description">Choose which runs to include in the comparison. Runs are ordered by most recent first.</p>
        <div class="run-selection-list" id="run-selection-list"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="document.getElementById('run-selection-modal').style.display='none'">Cancel</button>
        <button class="btn btn-primary" id="confirm-run-selection-btn">Apply Selection</button>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal" id="help-modal" style="display:none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Keyboard Shortcuts</h2>
        <button class="modal-close" onclick="document.getElementById('help-modal').style.display='none'">×</button>
      </div>
      <div class="modal-body">
        <div class="shortcut-group">
          <h4>Navigation</h4>
          <div class="shortcut"><span class="kbd">j</span> / <span class="kbd">↓</span> Next row</div>
          <div class="shortcut"><span class="kbd">k</span> / <span class="kbd">↑</span> Previous row</div>
          <div class="shortcut"><span class="kbd">g</span> First row</div>
          <div class="shortcut"><span class="kbd">G</span> Last row</div>
          <div class="shortcut"><span class="kbd">Enter</span> Open run details</div>
        </div>
        <div class="shortcut-group">
          <h4>Selection & Comparison</h4>
          <div class="shortcut"><span class="kbd">x</span> Toggle select row</div>
          <div class="shortcut"><span class="kbd">c</span> Compare selected</div>
          <div class="shortcut"><span class="kbd">Esc</span> Clear selection</div>
        </div>
        <div class="shortcut-group">
          <h4>Filters & Views</h4>
          <div class="shortcut"><span class="kbd">/</span> Focus search</div>
          <div class="shortcut"><span class="kbd">1-3</span> Quick filters</div>
          <div class="shortcut"><span class="kbd">h</span> Charts (dashboard)</div>
          <div class="shortcut"><span class="kbd">t</span> Runs (list)</div>
          <div class="shortcut"><span class="kbd">m</span> Models comparison</div>
        </div>
      </div>
      <div class="modal-footer help-footer">
        <img src="./static/qym_text.png" alt="qym" class="help-logo" />
      </div>
    </div>
  </div>

  <script src="./static/metrics.js"></script>
  <script src="./static/dashboard.js"></script>
</body>
</html>
