<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>قيِّم • Run Detail</title>
  <link rel="icon" type="image/png" href="../static/qym_icon.png">
  <link rel="stylesheet" href="../static/dashboard.css">
  <script src="../static/metrics.js"></script>
  <style>
    .run-container {
      padding: var(--space-lg);
      overflow-y: auto;
      height: calc(100vh - 100px);
    }
    .run-header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-sm);
      padding-bottom: 0;
      border-bottom: none;
    }
    .run-title {
      font-size: var(--font-sm);
      font-weight: 500;
      color: var(--text-muted);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .run-subtitle {
      display: none;
    }
    .back-link {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      color: var(--accent-primary);
      text-decoration: none;
      font-size: var(--font-sm);
    }
    .back-link:hover { text-decoration: underline; }

    /* ─── Hero Summary Card ─── */
    .run-summary {
      margin-bottom: var(--space-xl);
    }
    .run-summary-card {
      position: relative;
      background:
        radial-gradient(ellipse at 10% 0%, rgba(0, 212, 170, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 90% 100%, rgba(168, 85, 247, 0.04) 0%, transparent 50%),
        var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 10px;
      padding: 0;
      overflow: hidden;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
    }
    .run-summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg,
        var(--accent-primary) 0%,
        var(--accent-secondary) 45%,
        var(--accent-tertiary) 75%,
        transparent 100%);
      z-index: 1;
    }

    /* Hero top: identity + status */
    .hero-top {
      padding: var(--space-lg) var(--space-lg) var(--space-md);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--space-lg);
    }
    .hero-identity {
      flex: 1;
      min-width: 0;
    }
    .hero-run-name {
      font-family: var(--font-mono);
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
      word-break: break-all;
      line-height: 1.35;
      letter-spacing: -0.2px;
    }
    .hero-tags {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--space-sm);
      margin-top: 10px;
    }

    /* Hero status pill */
    .hero-status {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 7px 16px;
      border-radius: 100px;
      font-size: var(--font-xs);
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      white-space: nowrap;
      flex-shrink: 0;
      margin-top: 2px;
      background: var(--bg-elevated);
      color: var(--text-secondary);
      border: 1px solid var(--border-default);
    }
    .hero-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
      background: var(--text-muted);
    }
    .hero-status.completed {
      background: rgba(168, 85, 247, 0.1);
      color: #c084fc;
      border-color: rgba(168, 85, 247, 0.25);
    }
    .hero-status.completed .hero-status-dot {
      background: #a855f7;
      box-shadow: 0 0 8px rgba(168, 85, 247, 0.6);
    }
    .hero-status.running {
      background: rgba(0, 168, 255, 0.1);
      color: #60b8ff;
      border-color: rgba(0, 168, 255, 0.25);
    }
    .hero-status.running .hero-status-dot {
      background: var(--accent-secondary);
      box-shadow: 0 0 8px rgba(0, 168, 255, 0.6);
      animation: hero-pulse 2s ease-in-out infinite;
    }
    .hero-status.failed {
      background: rgba(239, 68, 68, 0.1);
      color: #f87171;
      border-color: rgba(239, 68, 68, 0.25);
    }
    .hero-status.failed .hero-status-dot {
      background: var(--error);
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
    }
    @keyframes hero-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(0.6); }
    }

    /* Config strip */
    .hero-config {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
      gap: 1px;
      background: var(--border-subtle);
      border-top: 1px solid var(--border-subtle);
    }
    .config-cell {
      background: rgba(26, 26, 40, 0.7);
      padding: 10px var(--space-md);
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.15s;
    }
    .config-cell:hover {
      background: var(--bg-elevated);
    }
    .config-cell-dot {
      width: 6px;
      height: 6px;
      border-radius: 2px;
      flex-shrink: 0;
      opacity: 0.6;
    }
    .config-cell-text {
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .config-cell-key {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-weight: 500;
      line-height: 1;
    }
    .config-cell-val {
      font-family: var(--font-mono);
      font-size: var(--font-sm);
      color: var(--text-primary);
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.3;
    }

    /* Stats section */
    .comparison-stats {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      padding: var(--space-lg);
      margin-bottom: var(--space-xl);
    }
    .section-title {
      font-size: var(--font-lg);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-md);
    }
    .overview-kpis {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }
    .stats-row-flex {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }
    .stats-row-flex .stat-box { flex: 1; min-width: 100px; }
    .stat-box {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      padding: var(--space-sm) var(--space-md);
    }
    .stat-box .stat-title {
      font-size: var(--font-xs);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .stat-info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: var(--accent-primary);
      color: var(--bg-primary);
      font-size: 10px;
      font-weight: 700;
      font-style: italic;
      font-family: Georgia, serif;
      cursor: help;
      position: relative;
      text-transform: lowercase;
      flex-shrink: 0;
    }
    .stat-info-icon:hover {
      background: var(--text-primary);
      color: var(--bg-primary);
      transform: scale(1.1);
    }
    .stat-info-tooltip {
      display: none;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 0;
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      padding: 10px 12px;
      width: 240px;
      font-size: var(--font-sm);
      font-weight: 400;
      font-style: normal;
      font-family: var(--font-sans);
      color: var(--text-secondary);
      text-transform: none;
      letter-spacing: normal;
      line-height: 1.5;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      text-align: left;
    }
    .stat-info-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 12px;
      border: 6px solid transparent;
      border-top-color: var(--border-default);
    }
    .stat-info-icon:hover .stat-info-tooltip { display: block; }
    .stat-box .stat-main {
      font-family: var(--font-mono);
      font-size: var(--font-md);
      font-weight: 600;
      color: var(--text-primary);
    }
    .stat-box .stat-main.score-5 { color: var(--score-5); }
    .stat-box .stat-main.score-4 { color: var(--score-4); }
    .stat-box .stat-main.score-3 { color: var(--score-3); }
    .stat-box .stat-main.score-2 { color: var(--score-2); }
    .stat-box .stat-main.score-1 { color: var(--score-1); }
    .stat-box .stat-detail {
      font-size: var(--font-xs);
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Distribution bar charts (shared) */
    .dist-chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
    }
    .dist-chart-col {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      gap: 2px;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .dist-chart-col:hover { opacity: 0.8; }
    .dist-chart-col .bar-count {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      line-height: 1;
    }
    .dist-chart-col .bar-fill {
      width: 100%;
      border-radius: 3px 3px 0 0;
    }
    .dist-chart-col .bar-label {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-secondary);
      text-align: center;
      white-space: nowrap;
      line-height: 1;
    }
    .dist-summary-stats {
      display: flex;
      gap: var(--space-md);
      margin-top: var(--space-sm);
      padding-top: var(--space-sm);
      border-top: 1px solid var(--border-subtle);
    }
    .dist-summary-stat {
      font-family: var(--font-mono);
      font-size: var(--font-sm);
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .dist-summary-stat .dst-label {
      font-family: var(--font-sans);
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.4px;
      font-weight: 500;
    }

    /* Distributions grid */
    .distributions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }
    .dist-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      padding: var(--space-md);
    }
    .dist-card-title {
      font-size: var(--font-sm);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    .dist-section-desc {
      font-size: var(--font-sm);
      color: var(--text-muted);
      margin-bottom: var(--space-md);
      line-height: 1.5;
    }

    /* ─── Overview Redesign ─── */
    .overview-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-lg);
      gap: var(--space-md);
    }
    .overview-header .section-title {
      margin-bottom: 0;
    }
    .overview-header-hint {
      font-size: var(--font-xs);
      color: var(--text-dim);
      margin-top: 3px;
      letter-spacing: 0.2px;
    }
    .overview-summary-pills {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-shrink: 0;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .summary-pill {
      font-size: var(--font-xs);
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--text-muted);
      padding: 4px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 100px;
      white-space: nowrap;
    }
    .summary-pill.pill-success {
      color: var(--score-5);
      border-color: rgba(16, 185, 129, 0.2);
      background: rgba(16, 185, 129, 0.06);
    }
    .summary-pill.pill-warn {
      color: var(--score-3);
      border-color: rgba(234, 179, 8, 0.2);
      background: rgba(234, 179, 8, 0.06);
    }
    .summary-pill.pill-error {
      color: var(--score-1);
      border-color: rgba(239, 68, 68, 0.2);
      background: rgba(239, 68, 68, 0.06);
    }

    .metric-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }
    .metric-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 10px;
      padding: var(--space-lg);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .metric-card:hover {
      border-color: var(--border-strong);
      box-shadow: 0 2px 16px rgba(0, 0, 0, 0.12);
    }
    .metric-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-md);
    }
    .metric-card-gauge {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    .gauge-ring {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: transform 0.25s;
    }
    .metric-card:hover .gauge-ring {
      transform: scale(1.08);
    }
    .gauge-ring-inner {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: var(--bg-surface);
    }
    .metric-card-info {
      min-width: 0;
    }
    .metric-card-value {
      font-family: var(--font-mono);
      font-size: 22px;
      font-weight: 700;
      line-height: 1;
    }
    .metric-card-value.score-5 { color: var(--score-5); }
    .metric-card-value.score-4 { color: var(--score-4); }
    .metric-card-value.score-3 { color: var(--score-3); }
    .metric-card-value.score-2 { color: var(--score-2); }
    .metric-card-value.score-1 { color: var(--score-1); }
    .metric-card-name {
      font-size: var(--font-sm);
      font-weight: 600;
      color: var(--text-secondary);
      margin-top: 3px;
      text-transform: capitalize;
      letter-spacing: 0.2px;
    }
    .metric-card-badge {
      font-size: 10px;
      font-family: var(--font-mono);
      color: var(--text-muted);
      background: var(--bg-elevated);
      padding: 3px 10px;
      border-radius: 100px;
      border: 1px solid var(--border-subtle);
      white-space: nowrap;
      flex-shrink: 0;
      align-self: flex-start;
    }

    /* Latency badge (replaces gauge ring for latency card) */
    .latency-badge {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      background: rgba(0, 168, 255, 0.08);
      border: 1.5px solid rgba(0, 168, 255, 0.2);
      flex-shrink: 0;
      transition: transform 0.25s;
    }
    .metric-card:hover .latency-badge {
      transform: scale(1.08);
    }
    .latency-badge-icon {
      font-size: 20px;
      line-height: 1;
    }

    /* Compact latency stats in card header */
    .latency-stats-compact {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 10px;
      align-self: center;
    }
    .latency-stats-compact span {
      font-size: 10px;
      font-weight: 500;
      font-family: var(--font-mono);
      white-space: nowrap;
      color: var(--text-muted);
    }
    .latency-stats-compact span b {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .threshold-control {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    .threshold-label {
      font-size: var(--font-xs);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .threshold-slider {
      -webkit-appearance: none;
      appearance: none;
      width: 120px;
      height: 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }
    .threshold-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: var(--accent-primary);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 212, 170, 0.4);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .threshold-slider::-webkit-slider-thumb:hover {
      transform: scale(1.15);
      box-shadow: 0 3px 10px rgba(0, 212, 170, 0.5);
    }
    .threshold-slider::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: var(--accent-primary);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 212, 170, 0.4);
    }
    .threshold-slider::-moz-range-track {
      background: var(--bg-elevated);
      height: 6px;
      border-radius: 3px;
    }
    .threshold-value {
      font-size: var(--font-sm);
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--accent-primary);
      min-width: 40px;
    }

    /* Metadata Breakdown cards */
    .breakdown-section { margin-bottom: var(--space-lg); }
    .breakdown-header {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: var(--font-md);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }
    .breakdown-icon { font-size: var(--font-sm); line-height: 1; }
    .breakdown-complexity .breakdown-icon,
    .breakdown-complexity .breakdown-header { color: #fbbf24; }
    .breakdown-domain .breakdown-icon,
    .breakdown-domain .breakdown-header { color: #60a5fa; }
    .breakdown-root-cause .breakdown-icon,
    .breakdown-root-cause .breakdown-header { color: #e07a5f; }
    .breakdown-root-cause .breakdown-card { border-left: 3px solid rgba(224, 122, 95, 0.3); }
    .breakdown-metric {
      font-size: var(--font-xs);
      font-family: var(--font-mono);
      color: var(--text-muted);
      font-weight: 400;
      padding: 1px 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      margin-left: 4px;
    }
    .breakdown-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: var(--space-sm);
    }
    .breakdown-card {
      background: var(--bg-elevated);
      border-radius: 6px;
      padding: var(--space-sm) var(--space-md);
      display: flex;
      flex-direction: column;
      gap: 3px;
      border: 1px solid var(--border-subtle);
      transition: border-color 0.15s;
    }
    .breakdown-card:hover { border-color: var(--border-default); }
    .breakdown-complexity .breakdown-card { border-left: 3px solid rgba(251, 191, 36, 0.3); }
    .breakdown-complexity .breakdown-card.complexity-easy { border-left-color: rgba(34, 197, 94, 0.5); }
    .breakdown-complexity .breakdown-card.complexity-easy .breakdown-card-label { color: #4ade80; }
    .breakdown-complexity .breakdown-card.complexity-medium { border-left-color: rgba(234, 179, 8, 0.5); }
    .breakdown-complexity .breakdown-card.complexity-medium .breakdown-card-label { color: #facc15; }
    .breakdown-complexity .breakdown-card.complexity-hard { border-left-color: rgba(239, 68, 68, 0.5); }
    .breakdown-complexity .breakdown-card.complexity-hard .breakdown-card-label { color: #f87171; }
    .breakdown-complexity .breakdown-card.complexity-expert { border-left-color: rgba(168, 85, 247, 0.5); }
    .breakdown-complexity .breakdown-card.complexity-expert .breakdown-card-label { color: #c084fc; }
    .breakdown-domain .breakdown-card { border-left: 3px solid rgba(96, 165, 250, 0.3); }
    .breakdown-card-top {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: var(--space-sm);
    }
    .breakdown-card-label {
      font-size: var(--font-sm);
      font-weight: 600;
      color: var(--text-primary);
      text-transform: capitalize;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
      flex: 1;
    }
    .breakdown-card-score-row {
      display: flex;
      align-items: baseline;
      gap: var(--space-sm);
    }
    .breakdown-card-scores {
      display: flex;
      gap: var(--space-md);
      margin: 2px 0;
    }
    .breakdown-card-scores .score-col {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .breakdown-card-scores .score-col-label {
      font-family: var(--font-sans);
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.4px;
      font-weight: 500;
    }
    .breakdown-card-scores .score-col-value {
      font-family: var(--font-mono);
      font-size: var(--font-md);
      font-weight: 700;
    }
    .breakdown-card-scores .score-col-value.score-5 { color: var(--score-5); }
    .breakdown-card-scores .score-col-value.score-4 { color: var(--score-4); }
    .breakdown-card-scores .score-col-value.score-3 { color: var(--score-3); }
    .breakdown-card-scores .score-col-value.score-2 { color: var(--score-2); }
    .breakdown-card-scores .score-col-value.score-1 { color: var(--score-1); }
    .breakdown-card-count {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      font-size: 10px;
      font-family: var(--font-mono);
      color: var(--text-muted);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 100px;
      padding: 1px 8px;
      flex-shrink: 0;
      letter-spacing: 0.3px;
    }
    .breakdown-card-count strong { color: var(--text-secondary); font-weight: 600; }
    .breakdown-card-score {
      font-family: var(--font-mono);
      font-size: var(--font-lg);
      font-weight: 700;
    }
    .breakdown-card-score.score-5 { color: var(--score-5); }
    .breakdown-card-score.score-4 { color: var(--score-4); }
    .breakdown-card-score.score-3 { color: var(--score-3); }
    .breakdown-card-score.score-2 { color: var(--score-2); }
    .breakdown-card-score.score-1 { color: var(--score-1); }
    .breakdown-card-details {
      display: flex;
      gap: var(--space-md);
      margin-top: 2px;
    }
    .breakdown-detail {
      font-family: var(--font-mono);
      font-size: var(--font-xs);
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .breakdown-detail-label {
      font-family: var(--font-sans);
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.4px;
      font-weight: 500;
    }

    /* Filter panel */
    .filter-panel {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      margin-bottom: var(--space-lg);
      overflow: visible;
    }
    .fp-filter-row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-end;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
    }
    .fp-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }
    .fp-label {
      font-size: 9px;
      font-family: var(--font-sans);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-weight: 500;
      line-height: 1;
      padding-left: 1px;
    }
    .fp-group .filter-select { min-width: unset; max-width: unset; }
    .fp-cat-group .multi-select-btn.has-selection {
      color: var(--accent-primary);
      font-weight: 600;
    }
    .fp-cat-group .multi-select-option .option-count {
      font-size: var(--font-xs);
      color: var(--text-muted);
      margin-left: auto;
    }
    .fp-cat-group .multi-select-dropdown .ms-actions {
      display: flex;
      gap: 4px;
      padding: 4px 8px;
      border-top: 1px solid var(--border-subtle);
    }
    .fp-cat-group .multi-select-dropdown .ms-action-btn {
      flex: 1;
      padding: 4px 0;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: var(--font-xs);
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.15s;
    }
    .fp-cat-group .multi-select-dropdown .ms-action-btn:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }
    .fp-gear-wrapper { display: flex; align-items: flex-end; }
    .fp-gear-btn.metadata-fields-btn {
      padding: var(--space-xs) var(--space-sm);
      padding-right: var(--space-sm);
      background: var(--bg-surface);
      background-image: none;
      border: 1px solid var(--border-default);
      border-radius: 3px;
      color: var(--text-muted);
      font-size: var(--font-base);
      cursor: pointer;
      transition: all 0.15s;
      line-height: 1;
    }
    .fp-gear-btn.metadata-fields-btn:hover {
      color: var(--text-primary);
      border-color: var(--border-strong);
      background-color: var(--bg-hover);
    }
    .fp-actions-spacer { flex: 1 1 0; }
    .fp-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
      align-self: flex-end;
    }
    .fp-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: var(--space-xs) var(--space-sm);
      background: transparent;
      border: 1px solid var(--border-default);
      border-radius: 3px;
      color: var(--text-muted);
      font-size: var(--font-xs);
      font-family: var(--font-sans);
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .fp-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-strong);
    }
    .fp-clear-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: var(--space-xs) var(--space-sm);
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 3px;
      color: #f87171;
      font-size: var(--font-xs);
      font-family: var(--font-sans);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
      visibility: hidden;
    }
    .fp-clear-btn.visible { visibility: visible; }
    .fp-clear-btn:hover {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.35);
      color: #fca5a5;
    }
    .fp-clear-x { font-size: 13px; font-weight: 600; line-height: 1; }
    .fp-clear-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 16px;
      height: 16px;
      padding: 0 4px;
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border-radius: 8px;
      font-size: 9px;
      font-weight: 700;
      line-height: 1;
    }
    .fp-btn.fp-export {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: var(--bg-void);
      font-size: var(--font-sm);
      font-weight: 500;
    }
    .fp-btn.fp-export:hover {
      background: #00e6b8;
      border-color: #00e6b8;
      color: var(--bg-void);
    }
    .fp-search-row { padding: 0 var(--space-md) var(--space-sm); }
    .fp-search {
      display: flex;
      align-items: center;
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: 3px;
      padding: 0 var(--space-sm);
      transition: border-color 0.15s;
    }
    .fp-search:focus-within { border-color: var(--accent-primary); }
    .fp-search-icon {
      color: var(--text-muted);
      font-size: var(--font-sm);
      flex-shrink: 0;
      margin-right: 6px;
      line-height: 1;
    }
    .fp-search input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: var(--font-sm);
      font-family: var(--font-mono);
      padding: var(--space-xs) 0;
      outline: none;
      min-width: 0;
    }
    .fp-search input::placeholder { color: var(--text-muted); }
    .fp-status {
      padding: var(--space-xs) var(--space-md);
      border-top: 1px solid var(--border-subtle);
    }
    .fp-status .filter-count {
      font-size: var(--font-xs);
      color: var(--text-muted);
      font-family: var(--font-mono);
    }
    .fp-status .filter-count .count-num {
      color: var(--accent-primary);
      font-weight: 600;
    }

    /* Items grid */
    .items-grid {
      display: flex;
      flex-direction: column;
      gap: var(--space-xl);
    }
    .item-card {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      padding: var(--space-md);
    }
    .item-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding-bottom: var(--space-sm);
      border-bottom: 1px solid var(--border-subtle);
    }
    .item-index {
      font-family: var(--font-mono);
      font-size: var(--font-md);
      font-weight: 600;
      color: var(--text-muted);
    }
    .item-input-row,
    .item-expected-row {
      background: var(--bg-elevated);
      padding: var(--space-sm);
      border-radius: 4px;
    }
    .item-input-row .input-label,
    .item-expected-row .expected-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: var(--font-xs);
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .item-input-row .input-text,
    .item-expected-row .expected-text {
      font-family: var(--font-mono);
      font-size: var(--font-sm);
      color: var(--text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .item-expected-row {
      background: var(--success-dim);
      border-left: 3px solid var(--success);
    }
    .item-expected-row .expected-label { color: var(--success); }
    .item-expected-row .expected-text.collapsed {
      max-height: 100px;
      overflow: hidden;
      position: relative;
    }
    .item-expected-row .expected-text.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 40px;
      background: linear-gradient(transparent, var(--success-dim));
      pointer-events: none;
    }
    .expected-toggle {
      display: inline-block;
      margin-top: 4px;
      font-size: var(--font-xs);
      color: var(--success);
      cursor: pointer;
      font-weight: 600;
      background: none;
      border: none;
      padding: 0;
      font-family: var(--font-sans);
    }
    .expected-toggle:hover { text-decoration: underline; }

    /* Single run output (full width) */
    .item-run-output {
      border-left: 3px solid var(--accent-primary);
      padding-left: var(--space-sm);
      background: var(--bg-elevated);
      border-radius: 0 4px 4px 0;
      padding: var(--space-sm);
    }
    .item-run-output .output-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-xs);
      flex-wrap: wrap;
      gap: 4px;
    }
    .item-run-output .run-label {
      font-size: var(--font-xs);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .item-run-output .output-badges {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .item-run-output .metric-badge,
    .item-run-output .latency-badge {
      font-family: var(--font-mono);
      font-size: var(--font-xs);
      padding: 2px 6px;
      border-radius: 3px;
      background: var(--bg-surface);
    }
    .item-run-output .metric-badge.score-5 { background: var(--success-dim); color: var(--score-5); }
    .item-run-output .metric-badge.score-4 { background: rgba(132, 204, 22, 0.15); color: var(--score-4); }
    .item-run-output .metric-badge.score-3 { background: rgba(234, 179, 8, 0.15); color: var(--score-3); }
    .item-run-output .metric-badge.score-2 { background: rgba(249, 115, 22, 0.15); color: var(--score-2); }
    .item-run-output .metric-badge.score-1 { background: var(--error-dim); color: var(--score-1); }
    .item-run-output .latency-badge {
      display: inline;
      color: var(--text-muted);
      width: auto;
      height: auto;
      border: none;
      background: var(--bg-surface);
      border-radius: 3px;
    }
    .item-run-output .start-badge {
      font-family: var(--font-mono);
      font-size: var(--font-xs);
      padding: 2px 6px;
      border-radius: 3px;
      background: var(--bg-surface);
      color: var(--text-muted);
    }
    .item-run-output .trace-link {
      display: inline-flex;
      align-items: center;
      padding: 1px 5px;
      background: rgba(225, 29, 72, 0.15);
      color: #e11d48;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 500;
      text-decoration: none;
      transition: background 0.15s;
    }
    .item-run-output .trace-link:hover { background: rgba(225, 29, 72, 0.25); }
    .item-run-output .output-text {
      font-family: var(--font-mono);
      font-size: var(--font-sm);
      color: var(--text-secondary);
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 200px;
      overflow-y: auto;
    }

    /* Metric edit */
    .metric-edit-block {
      margin-top: 6px;
      padding: 6px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 6px;
    }
    .metric-edit-title { font-size: var(--font-xs); color: var(--text-muted); margin-bottom: 4px; }
    .metric-edit-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-xs);
    }
    .metric-edit-controls { display: flex; gap: 6px; align-items: center; }
    .metric-edit-controls.hidden { display: none; }
    .metric-edit-block.hidden { display: none; }
    .metric-edit-input {
      width: 90px;
      background: var(--bg-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      padding: 4px 6px;
      font-family: var(--font-mono);
      font-size: var(--font-xs);
    }
    .metric-edit-save {
      background: transparent;
      border: 1px solid var(--border-default);
      color: var(--text-primary);
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: var(--font-xs);
    }
    .metric-edit-save:disabled { opacity: 0.6; cursor: default; }
    .metric-edit-status { font-size: var(--font-xs); color: var(--text-muted); }
    .metric-edit-badge {
      display: inline-flex;
      align-items: center;
      padding: 1px 5px;
      background: rgba(34,197,94,0.15);
      color: var(--success);
      border-radius: 3px;
      font-size: 10px;
      font-weight: 500;
    }
    .metric-edit-badge::before { content: "\25CF"; font-size: 7px; margin-right: 4px; }
    .metric-edit-open {
      background: #1f2430;
      border: none;
      color: #a7b0c0;
      border-radius: 6px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 6px;
      line-height: 1;
      opacity: 0.95;
    }
    .metric-edit-open:hover { opacity: 1; background: #222a36; color: #c3c9d6; }
    .metric-edit-meta { margin-top: 4px; font-size: var(--font-xs); color: var(--text-muted); }

    .metric-score-row {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 8px;
      padding: 2px 0;
    }
    .metric-score-meta { display: inline-flex; align-items: center; gap: 6px; }
    .metric-score-row.highlighted {
      background: var(--bg-hover);
      margin: 0 -4px;
      padding: 2px 4px;
      border-radius: 3px;
    }
    .metric-score-name { font-size: var(--font-xs); color: var(--text-muted); min-width: 80px; }
    .metric-score-value { font-family: var(--font-mono); font-size: var(--font-sm); font-weight: 600; }
    .metric-scores-inline {
      margin-top: var(--space-sm);
      padding-top: var(--space-sm);
      border-top: 1px solid var(--border-subtle);
    }
    .passfail-badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 3px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .passfail-badge.pass { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .passfail-badge.fail { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

    /* Root cause */
    .root-cause-row {
      margin-top: var(--space-sm);
      padding-top: var(--space-sm);
      border-top: 1px solid var(--border-subtle);
    }

    /* ── Feedback section (formerly "root cause notes") ── */
    .feedback-section {
      margin-top: 6px;
      background: var(--bg-base);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      overflow: hidden;
      transition: border-color 0.2s;
    }
    .feedback-section:hover { border-color: var(--border-default); }

    /* Display state */
    .feedback-display {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 10px;
      cursor: pointer;
      transition: background 0.15s;
      min-height: 34px;
    }
    .feedback-display:hover { background: var(--bg-surface); }
    .feedback-icon {
      flex-shrink: 0;
      width: 14px;
      height: 14px;
      margin-top: 1px;
      color: var(--text-dim);
      transition: color 0.15s;
    }
    .feedback-display:hover .feedback-icon { color: var(--text-muted); }
    .feedback-text {
      flex: 1;
      font-size: var(--font-xs);
      line-height: 1.5;
      color: var(--text-secondary);
      font-family: var(--font-sans);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .feedback-placeholder {
      color: var(--text-dim);
      font-style: italic;
      transition: color 0.15s;
    }
    .feedback-display:hover .feedback-placeholder { color: var(--text-muted); }

    /* Edit state */
    .feedback-edit {
      padding: 8px;
    }
    .feedback-edit textarea {
      width: 100%;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 4px;
      padding: 8px 10px;
      font-size: var(--font-xs);
      color: var(--text-primary);
      font-family: var(--font-sans);
      resize: vertical;
      min-height: 48px;
      max-height: 120px;
      line-height: 1.5;
      transition: border-color 0.15s;
    }
    .feedback-edit textarea:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 1px rgba(0,212,170,0.15); }
    .feedback-edit textarea::placeholder { color: var(--text-dim); }
    .feedback-edit-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }
    .feedback-btn {
      padding: 4px 12px;
      border: none;
      border-radius: 4px;
      font-size: var(--font-xs);
      font-weight: 600;
      font-family: var(--font-sans);
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .feedback-btn-cancel {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border-default);
    }
    .feedback-btn-cancel:hover { background: var(--bg-hover); color: var(--text-secondary); }
    .feedback-btn-save {
      background: var(--accent-primary);
      color: var(--bg-void);
    }
    .feedback-btn-save:hover { background: #00e6b8; }

    /* Save success flash */
    .feedback-section.feedback-saved {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 1px rgba(0,212,170,0.15);
    }
    .root-cause-assign-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 100px;
      font-size: var(--font-xs);
      font-family: var(--font-mono);
      background: var(--bg-surface);
      border: 1px dashed var(--border-default);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
    }
    .root-cause-assign-btn:hover {
      border-color: #e07a5f;
      color: #e07a5f;
      background: rgba(224, 122, 95, 0.05);
    }
    .root-cause-dropdown {
      position: fixed;
      z-index: 200;
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      padding: var(--space-sm);
      min-width: 220px;
      max-height: 320px;
      overflow-y: auto;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    .root-cause-dropdown .rc-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      font-size: var(--font-sm);
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.1s;
    }
    .root-cause-dropdown .rc-option:hover { background: var(--bg-hover); color: var(--text-primary); }
    .root-cause-dropdown .rc-option.active { color: #e07a5f; font-weight: 600; }
    .root-cause-dropdown .rc-option .rc-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .root-cause-dropdown .rc-divider { height: 1px; background: var(--border-subtle); margin: 4px 0; }
    .root-cause-dropdown .rc-custom-input { display: flex; gap: 4px; padding: 6px; }
    .root-cause-dropdown .rc-custom-input input {
      flex: 1;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 3px;
      padding: 4px 8px;
      font-size: var(--font-sm);
      color: var(--text-primary);
      font-family: var(--font-mono);
    }
    .root-cause-dropdown .rc-custom-input input:focus { outline: none; border-color: var(--accent-primary); }
    .root-cause-dropdown .rc-custom-input button {
      padding: 4px 10px;
      background: var(--accent-primary);
      color: var(--bg-primary);
      border: none;
      border-radius: 3px;
      font-size: var(--font-xs);
      cursor: pointer;
      font-weight: 600;
    }

    /* Metadata badges */
    .item-metadata-row {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: 6px var(--space-sm);
      background: var(--bg-elevated);
      border-radius: 4px;
    }
    .item-meta-badges { display: flex; gap: 6px; flex-shrink: 0; }
    .meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 100px;
      font-size: var(--font-xs);
      font-family: var(--font-mono);
      font-weight: 600;
      white-space: nowrap;
    }
    .meta-badge .badge-icon { font-size: 10px; line-height: 1; }
    .meta-badge.badge-complexity {
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.25);
      color: #fbbf24;
    }
    .meta-badge.badge-complexity.complexity-easy { background: rgba(34, 197, 94, 0.12); border-color: rgba(34, 197, 94, 0.3); color: #4ade80; }
    .meta-badge.badge-complexity.complexity-medium { background: rgba(234, 179, 8, 0.12); border-color: rgba(234, 179, 8, 0.3); color: #facc15; }
    .meta-badge.badge-complexity.complexity-hard { background: rgba(239, 68, 68, 0.12); border-color: rgba(239, 68, 68, 0.3); color: #f87171; }
    .meta-badge.badge-complexity.complexity-very-hard,
    .meta-badge.badge-complexity.complexity-expert { background: rgba(168, 85, 247, 0.12); border-color: rgba(168, 85, 247, 0.3); color: #c084fc; }
    .meta-badge.badge-domain {
      background: rgba(96, 165, 250, 0.1);
      border: 1px solid rgba(96, 165, 250, 0.25);
      color: #60a5fa;
    }
    .meta-badge.badge-root-cause {
      background: rgba(224, 122, 95, 0.1);
      border: 1px solid rgba(224, 122, 95, 0.25);
      color: #e07a5f;
      cursor: pointer;
      transition: all 0.15s;
    }
    .meta-badge.badge-root-cause:hover {
      background: rgba(224, 122, 95, 0.2);
      border-color: rgba(224, 122, 95, 0.4);
    }
    .item-meta-sep { width: 1px; height: 16px; background: var(--border-default); flex-shrink: 0; }
    .item-metadata-tags { display: flex; flex-wrap: wrap; gap: 4px; }
    .item-metadata-tag {
      display: inline-flex;
      gap: 4px;
      padding: 2px 8px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      font-size: var(--font-xs);
      font-family: var(--font-mono);
    }
    .item-metadata-tag .meta-key { color: var(--text-muted); }
    .item-metadata-tag .meta-val { color: var(--text-secondary); font-weight: 600; }

    /* Metadata field selector */
    .metadata-fields-selector { display: inline-flex; align-items: center; gap: 4px; }
    .metadata-fields-dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      right: 0;
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      padding: var(--space-sm);
      z-index: 100;
      min-width: 180px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .metadata-fields-dropdown.open { display: block; }
    .metadata-fields-dropdown label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      font-size: var(--font-xs);
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 3px;
      transition: background 0.1s;
    }
    .metadata-fields-dropdown label:hover { color: var(--text-primary); background: var(--bg-hover); }

    /* Metric details toggle + content */
    .metric-details-toggle {
      font-size: var(--font-sm);
      color: var(--accent-primary);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 4px;
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      margin-top: var(--space-sm);
    }
    .metric-details-toggle:hover { background: var(--bg-hover); border-color: var(--accent-primary); }
    .run-metric-details {
      margin-top: var(--space-sm);
      display: none;
    }
    .run-metric-details.expanded { display: block; }
    .metric-detail-row { padding: 8px 0; border-bottom: 1px solid var(--border-subtle); }
    .metric-detail-row:last-child { border-bottom: none; }
    .metric-detail-name { font-size: var(--font-sm); color: var(--text-secondary); font-weight: 600; margin-bottom: 6px; display: block; }
    .metric-detail-value {
      font-family: var(--font-mono);
      font-size: var(--font-sm);
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.6;
    }
    .metric-detail-value .meta-table {
      width: 100%;
      border-collapse: collapse;
      margin: 4px 0;
      font-size: var(--font-xs);
      white-space: nowrap;
    }
    .metric-detail-value .meta-table th,
    .metric-detail-value .meta-table td {
      padding: 3px 10px;
      border: 1px solid var(--border-subtle);
      text-align: start;
    }
    .metric-detail-value .meta-table th {
      background: var(--bg-elevated);
      color: var(--text-muted);
      font-weight: 600;
    }
    .metric-detail-value .meta-table td {
      color: var(--text-secondary);
    }
    .metric-detail-value .meta-table tr:hover td {
      background: var(--bg-hover);
    }
    .meta-table-wrapper {
      position: relative;
    }
    .meta-table-wrapper.collapsed {
      max-height: 180px;
      overflow: hidden;
    }
    .meta-table-wrapper.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 40px;
      background: linear-gradient(transparent, var(--bg-primary));
      pointer-events: none;
    }
    .meta-table-toggle {
      display: inline-block;
      margin-top: 4px;
      font-size: var(--font-xs);
      color: var(--accent-primary);
      cursor: pointer;
      font-weight: 600;
      background: none;
      border: none;
      padding: 0;
      font-family: var(--font-sans);
    }
    .meta-table-toggle:hover { text-decoration: underline; }

    /* Formatted objects */
    .formatted-object, .formatted-array { font-family: var(--font-mono); font-size: var(--font-sm); line-height: 1.6; }
    .formatted-row {
      padding: 6px 0;
      padding-left: var(--space-md);
      border-left: 2px solid var(--border-subtle);
      margin-left: 2px;
      margin-bottom: 4px;
      position: relative;
    }
    .formatted-row:hover { background: var(--bg-hover); border-left-color: var(--accent-primary); }
    .formatted-key { color: #60a5fa; font-weight: 600; display: block; margin-bottom: 4px; text-transform: uppercase; font-size: var(--font-xs); letter-spacing: 0.5px; }
    .formatted-string { color: var(--text-secondary); white-space: pre-wrap; word-break: break-word; display: block; line-height: 1.5; }
    .formatted-number { color: #fbbf24; font-weight: 600; }
    .formatted-boolean { color: #a855f7; font-weight: 600; }
    .formatted-null { color: var(--text-muted); font-style: italic; }
    .formatted-array-item {
      padding: 6px 0;
      padding-left: var(--space-md);
      border-left: 2px solid var(--border-subtle);
      margin-left: 2px;
      margin-bottom: 4px;
    }
    .formatted-array-item:hover { background: var(--bg-hover); border-left-color: var(--accent-primary); }
    .formatted-index { color: #60a5fa; font-size: var(--font-xs); margin-right: 4px; font-weight: 600; }

    /* Copy button */
    .copy-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px;
      line-height: 1;
      opacity: 0.4;
      transition: all 0.15s;
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
    }
    .copy-btn svg { width: 14px; height: 14px; }
    .copy-btn:hover { opacity: 1; }
    .copy-btn:hover svg { stroke: var(--accent-primary); }
    .copy-btn.copied svg { stroke: var(--success); }
    .copy-btn.copied { opacity: 1; }
    .formatted-row > .copy-btn { position: absolute; top: 6px; right: 4px; opacity: 0; }
    .formatted-row:hover > .copy-btn { opacity: 0.4; }
    .formatted-row:hover > .copy-btn:hover { opacity: 1; }
    .formatted-row > .copy-btn.copied { opacity: 1; }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: var(--space-sm);
      margin-top: var(--space-lg);
    }
    .pagination button {
      padding: var(--space-xs) var(--space-md);
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .pagination button:hover:not(:disabled) { background: var(--bg-hover); }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination .page-info { display: flex; align-items: center; font-size: var(--font-sm); color: var(--text-muted); }

    /* Loading/empty */
    .run-loading, .run-empty, .run-error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: var(--text-muted);
    }
    .run-loading .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-default);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: var(--space-md);
    }

    /* Status badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 100px;
      font-size: var(--font-xs);
      font-weight: 600;
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-badge.completed { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .status-badge.failed { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .status-badge.running { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-badge.pending { background: rgba(234, 179, 8, 0.15); color: #eab308; }
    .status-badge.submitted { background: rgba(168, 85, 247, 0.15); color: #a855f7; }

    .langfuse-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      background: rgba(225, 29, 72, 0.1);
      color: #e11d48;
      border-radius: 100px;
      font-size: var(--font-xs);
      font-weight: 500;
      text-decoration: none;
      transition: background 0.15s;
    }
    .langfuse-link:hover { background: rgba(225, 29, 72, 0.2); }

    /* Export Column Selector Modal */
    .export-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .export-modal-overlay.open { display: flex; }
    .export-modal {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      width: 520px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .export-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-sm) var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }
    .export-modal-header h3 {
      margin: 0;
      font-size: var(--font-md);
      font-weight: 600;
      color: var(--text-primary);
    }
    .export-modal-actions-top {
      display: flex;
      gap: 4px;
    }
    .export-modal-actions-top button {
      background: none;
      border: 1px solid var(--border-default);
      color: var(--text-muted);
      font-size: var(--font-xs);
      padding: 2px 10px;
      cursor: pointer;
      font-family: var(--font-sans);
      border-radius: 3px;
      transition: all 0.15s;
    }
    .export-modal-actions-top button:hover {
      color: var(--text-primary);
      border-color: var(--border-strong);
      background: var(--bg-hover);
    }
    .export-modal-body {
      overflow-y: auto;
      padding: var(--space-xs) 0;
      flex: 1;
    }
    .export-group {
      margin-bottom: 0;
      border-bottom: 1px solid var(--border-subtle);
    }
    .export-group:last-child { border-bottom: none; }
    .export-group-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      cursor: pointer;
      user-select: none;
      transition: background 0.1s;
    }
    .export-group-header:hover { background: var(--bg-hover); }
    .export-group-header .group-toggle {
      font-size: 10px;
      color: var(--text-muted);
      width: 12px;
      transition: transform 0.15s;
    }
    .export-group-header .group-toggle.collapsed { transform: rotate(-90deg); }
    .export-group-header .group-name {
      font-size: var(--font-sm);
      font-weight: 600;
      color: var(--text-primary);
    }
    .export-group-header .group-check {
      margin-left: auto;
      width: 12px;
      height: 12px;
      accent-color: var(--accent-primary);
    }
    .export-group-items {
      padding-left: 0;
    }
    .export-group-items.collapsed { display: none; }
    .export-col-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) var(--space-md);
      padding-left: calc(var(--space-md) + 12px + var(--space-sm));
      font-size: var(--font-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: background 0.1s;
    }
    .export-col-item:hover { background: var(--bg-hover); }
    .export-col-item.indent {
      padding-left: calc(var(--space-md) + 12px + var(--space-sm) + 16px);
      color: var(--text-muted);
      font-size: var(--font-xs);
    }
    .export-col-item input[type="checkbox"] {
      flex-shrink: 0;
      width: 12px;
      height: 12px;
      accent-color: var(--accent-primary);
      pointer-events: none;
    }
    .export-modal-footer {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      border-top: 1px solid var(--border-subtle);
    }
    .export-modal-footer .export-cancel {
      padding: var(--space-xs) var(--space-sm);
      background: none;
      border: 1px solid var(--border-default);
      border-radius: 3px;
      color: var(--text-muted);
      font-size: var(--font-sm);
      cursor: pointer;
      font-family: var(--font-sans);
      transition: all 0.15s;
    }
    .export-modal-footer .export-cancel:hover {
      color: var(--text-primary);
      border-color: var(--border-strong);
      background: var(--bg-hover);
    }
    .export-modal-footer .export-confirm {
      padding: var(--space-xs) var(--space-md);
      background: var(--accent-primary);
      border: 1px solid var(--accent-primary);
      border-radius: 3px;
      color: var(--bg-void);
      font-size: var(--font-sm);
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font-sans);
      transition: all 0.15s;
    }
    .export-modal-footer .export-confirm:hover {
      background: #00e6b8;
      border-color: #00e6b8;
    }
    /* ── Auto-Analyze UI ── */
    .auto-analyze-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(0, 168, 255, 0.15));
        border: 1px solid rgba(168, 85, 247, 0.3);
        border-radius: 6px;
        color: #c084fc;
        font-size: var(--font-sm);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    .auto-analyze-btn:hover {
        background: linear-gradient(135deg, rgba(168, 85, 247, 0.25), rgba(0, 168, 255, 0.25));
        border-color: rgba(168, 85, 247, 0.5);
        transform: translateY(-1px);
    }
    .auto-analyze-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    .auto-analyze-btn .ai-icon { font-size: 14px; }

    .analyze-panel {
        background: var(--bg-surface);
        border: 1px solid rgba(168, 85, 247, 0.2);
        border-radius: 8px;
        padding: var(--space-md);
        margin-bottom: var(--space-lg);
        display: none;
    }
    .analyze-panel.visible { display: block; }
    .analyze-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-md);
    }
    .analyze-panel-title {
        font-size: var(--font-md);
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .analyze-filters {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-sm);
        align-items: center;
        margin-bottom: var(--space-md);
    }
    .analyze-filters .fp-group {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .analyze-progress {
        display: none;
        padding: var(--space-sm);
        background: var(--bg-elevated);
        border-radius: 6px;
        margin-bottom: var(--space-sm);
    }
    .analyze-progress.visible { display: block; }
    .analyze-progress-bar {
        height: 4px;
        background: var(--border-subtle);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 6px;
    }
    .analyze-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #a855f7, #00a8ff);
        border-radius: 2px;
        transition: width 0.3s;
        animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }
    .analyze-stats {
        font-size: var(--font-sm);
        color: var(--text-muted);
    }
    .analyze-stat-val { font-weight: 600; color: var(--text-primary); }

    /* AI-suggested root cause badge styling */
    .badge-root-cause.ai-suggested {
        border-style: dashed !important;
    }
    .badge-root-cause .ai-indicator {
        font-size: 11px;
        margin-right: 2px;
    }
    .badge-root-cause .confidence-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 4px;
        vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toast-container"></div>
  <header class="stats-bar">
    <div class="stats-bar-left">
      <a href="/" class="logo" id="logo-link" style="text-decoration:none;">
        <img src="../static/qym_text.png" alt="قيِّم" class="logo-text-img" style="cursor:pointer;" />
      </a>
      <div class="stat-cells">
        <div class="stat-cell">
          <span class="stat-label">RUN</span>
          <span class="stat-value" id="hdr-run-name">—</span>
        </div>
        <div class="stat-cell">
          <span class="stat-label">STATUS</span>
          <span class="stat-value" id="hdr-status">—</span>
        </div>
        <div class="stat-cell">
          <span class="stat-label">DATASET</span>
          <span class="stat-value" id="hdr-dataset">—</span>
        </div>
        <div class="stat-cell">
          <span class="stat-label">MODEL</span>
          <span class="stat-value" id="hdr-model">—</span>
        </div>
        <div class="stat-cell">
          <span class="stat-label">TOTAL ITEMS</span>
          <span class="stat-value" id="hdr-total">—</span>
        </div>
        <div class="stat-cell">
          <span class="stat-label">METRICS</span>
          <span class="stat-value" id="hdr-metrics">—</span>
        </div>
      </div>
    </div>
  </header>

  <main class="run-container">
    <div class="run-loading" id="loading">
      <div class="spinner"></div>
      <span>Loading run data...</span>
    </div>

    <div class="run-error" id="error-state" style="display:none;">
      <div style="font-size:48px;margin-bottom:var(--space-md);">!</div>
      <h2 id="error-title">Error</h2>
      <p id="error-message">Could not load run data.</p>
      <a href="" class="back-link" id="back-link-error" style="margin-top:var(--space-md);">&larr; Back to Dashboard</a>
    </div>

    <div class="run-empty" id="empty" style="display:none;">
      <div style="font-size:48px;margin-bottom:var(--space-md);">&empty;</div>
      <h2>Run not found</h2>
      <p>The requested run could not be found.</p>
      <a href="" class="back-link" id="back-link-empty" style="margin-top:var(--space-md);">&larr; Back to Dashboard</a>
    </div>

    <div id="run-content" style="display:none;">
      <div class="run-header-bar">
        <div>
          <div class="run-title">Run Detail</div>
          <div class="run-subtitle" id="run-subtitle">—</div>
        </div>
        <a href="" class="back-link" id="back-link-header">&larr; Back to Dashboard</a>
      </div>

      <div class="run-summary" id="run-summary"></div>

      <div id="overview-section"></div>

      <div id="error-analysis-section" style="display:none;">
        <h3 class="section-title">Error Analysis</h3>
        <div class="comparison-stats" id="error-analysis-container"></div>
      </div>

      <div id="metadata-breakdown"></div>

      <div id="analyze-panel" class="analyze-panel">
          <div class="analyze-panel-header">
              <span class="analyze-panel-title">
                  <span class="ai-icon">🤖</span> Auto Root Cause Analysis
              </span>
              <button id="analyze-panel-close" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:18px;" title="Close">&times;</button>
          </div>
          <div class="analyze-filters">
              <div class="fp-group">
                  <span class="fp-label" style="font-size:var(--font-xs);color:var(--text-muted);">Analyze</span>
                  <select id="analyze-item-filter" class="filter-select" style="padding:4px 8px;background:var(--bg-elevated);border:1px solid var(--border-default);border-radius:4px;color:var(--text-primary);font-size:var(--font-xs);">
                      <option value="all">All Items</option>
                      <option value="failed" selected>Failed Items</option>
                      <option value="passed">Passed Items</option>
                      <option value="errors">Error Items</option>
                  </select>
              </div>
              <div class="fp-group">
                  <span class="fp-label" style="font-size:var(--font-xs);color:var(--text-muted);">Score below</span>
                  <input type="number" id="analyze-max-score" style="width:65px;padding:4px 8px;background:var(--bg-elevated);border:1px solid var(--border-default);border-radius:4px;color:var(--text-primary);font-size:var(--font-xs);" min="0" max="1" step="0.1" value="0.8" />
              </div>
              <div class="fp-group">
                  <label style="display:flex;align-items:center;gap:4px;font-size:var(--font-xs);color:var(--text-secondary);cursor:pointer;">
                      <input type="checkbox" id="analyze-only-new" checked />
                      Skip already analyzed
                  </label>
              </div>
              <div class="fp-group" style="margin-left:auto;">
                  <button id="run-analysis-btn" class="auto-analyze-btn">
                      <span class="ai-icon">🤖</span> Run Analysis
                  </button>
              </div>
          </div>
          <div id="analyze-progress" class="analyze-progress">
              <div class="analyze-stats">
                  Analyzing <span class="analyze-stat-val" id="analyze-count">0</span> items...
              </div>
              <div class="analyze-progress-bar">
                  <div class="analyze-progress-fill" id="analyze-progress-fill" style="width:0%"></div>
              </div>
          </div>
          <div id="analyze-results" style="display:none;"></div>
      </div>

      <div class="items-comparison">
        <h3 class="section-title">Item-by-Item Detail</h3>
        <div class="filter-panel">
          <div class="fp-filter-row">
            <div class="fp-group" id="fp-metric-group">
              <span class="fp-label">Metric</span>
              <select id="items-metric-select" class="filter-select"></select>
            </div>
            <div class="fp-group">
              <span class="fp-label">Show</span>
              <select id="item-filter" class="filter-select">
                <option value="all">All Items</option>
                <option value="passed">Passed</option>
                <option value="failed">Failed</option>
                <option value="errors">With Errors</option>
              </select>
            </div>
            <div class="fp-group" id="fp-threshold-group" style="display:none;">
              <span class="fp-label">Pass if &ge;</span>
              <div class="threshold-control" id="threshold-control">
                <input type="range" id="threshold-slider" class="threshold-slider" min="0" max="100" step="5" value="80">
                <span class="threshold-value" id="threshold-value">80%</span>
              </div>
            </div>
            <div class="fp-group">
              <span class="fp-label">Sort</span>
              <select id="sort-select" class="filter-select">
                <option value="index">Index</option>
                <option value="score_asc">Score &uarr;</option>
                <option value="score_desc">Score &darr;</option>
                <option value="latency_asc">Latency &uarr;</option>
                <option value="latency_desc">Latency &darr;</option>
              </select>
            </div>
            <div class="fp-group fp-cat-group" id="fp-cat-complexity" style="display:none;">
              <span class="fp-label">Complexity</span>
              <div class="multi-select-wrapper">
                <button class="multi-select-btn" id="complexity-ms-btn">All Complexity</button>
                <div class="multi-select-dropdown" id="complexity-ms-dropdown"></div>
              </div>
            </div>
            <div class="fp-group fp-cat-group" id="fp-cat-domain" style="display:none;">
              <span class="fp-label">Domain</span>
              <div class="multi-select-wrapper">
                <button class="multi-select-btn" id="domain-ms-btn">All Domains</button>
                <div class="multi-select-dropdown" id="domain-ms-dropdown"></div>
              </div>
            </div>
            <div class="fp-group fp-cat-group" id="fp-cat-root_cause" style="display:none;">
              <span class="fp-label">Root Cause</span>
              <div class="multi-select-wrapper">
                <button class="multi-select-btn" id="root_cause-ms-btn">All Root Causes</button>
                <div class="multi-select-dropdown" id="root_cause-ms-dropdown"></div>
              </div>
            </div>
            <div class="fp-gear-wrapper" id="fp-meta-fields" style="display:none;">
              <div class="metadata-fields-selector" style="position:relative;">
                <button class="fp-gear-btn metadata-fields-btn" id="metadata-fields-btn" title="Choose which item metadata fields to display">&#9881; Item</button>
                <div class="metadata-fields-dropdown" id="metadata-fields-dropdown"></div>
              </div>
            </div>
            <div class="fp-gear-wrapper" id="fp-metric-meta-fields" style="display:none;">
              <div class="metadata-fields-selector" style="position:relative;">
                <button class="fp-gear-btn metadata-fields-btn" id="metric-meta-fields-btn" title="Choose which metric metadata fields to display">&#9881; Metric</button>
                <div class="metadata-fields-dropdown" id="metric-meta-fields-dropdown"></div>
              </div>
            </div>
            <div class="fp-actions-spacer"></div>
            <div class="fp-actions">
              <button class="fp-clear-btn" id="clear-all-btn" title="Clear all active filters">
                <span class="fp-clear-x">&times;</span> Clear <span class="fp-clear-count" id="active-filter-count">0</span>
              </button>
              <button class="fp-btn fp-export" id="export-filtered-btn" title="Export filtered items as CSV">Export CSV</button>
            </div>
          </div>
          <div class="fp-search-row">
            <div class="fp-search">
              <span class="fp-search-icon">&#x2315;</span>
              <input type="text" id="items-search" placeholder="Search inputs / outputs..." />
            </div>
          </div>
          <div class="fp-status">
            <span class="filter-count" id="filter-count"></span>
          </div>
        </div>
        <div class="items-grid" id="items-grid"></div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>
  </main>

  <script>
    (() => {
      'use strict';

      const BASE_URL = (() => {
        const path = window.location.pathname;
        const runIdx = path.indexOf('/run/');
        if (runIdx >= 0) {
          const base = path.substring(0, runIdx + 1);
          return window.location.origin + base;
        }
        let base = path;
        if (!base.endsWith('/')) base = base.substring(0, base.lastIndexOf('/') + 1) || '/';
        return window.location.origin + base;
      })();

      const RUN_ID = (() => {
        const path = window.location.pathname;
        const runIdx = path.indexOf('/run/');
        return runIdx >= 0 ? path.substring(runIdx + 5) : null;
      })();

      function apiUrl(path) {
        return BASE_URL + path.replace(/^\.?\/?/, '');
      }

      // Fix back links and logo link
      try {
        const backUrl = apiUrl('');
        document.getElementById('back-link-header').href = backUrl;
        document.getElementById('back-link-error').href = backUrl;
        document.getElementById('back-link-empty').href = backUrl;
        document.getElementById('logo-link').href = backUrl;
      } catch {}

      const ROOT_CAUSE_PRESETS = [
        'Hallucination', 'Incomplete Answer', 'Wrong Format', 'Context Missing',
        'Reasoning Error', 'Tool Use Error', 'Instruction Following', 'Knowledge Gap',
      ];
      const ROOT_CAUSE_COLORS = {
        'Hallucination': '#ef4444', 'Incomplete Answer': '#f97316',
        'Wrong Format': '#00d4aa', 'Context Missing': '#3b82f6',
        'Reasoning Error': '#a855f7', 'Tool Use Error': '#ec4899',
        'Instruction Following': '#14b8a6', 'Knowledge Gap': '#6366f1',
      };

      const COPY_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="#9898a8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
      const CHECK_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';

      const formatPercent = window.QymMetrics.formatPercent;
      const formatLatency = window.QymMetrics.formatLatency;

      const state = {
        run: null,
        snapshot: null,
        allMetrics: [],
        selectedMetric: null,
        itemFilter: 'all',
        sortBy: 'index',
        page: 1,
        pageSize: 20,
        searchQuery: '',
        metricThresholds: {},
        metricIsBoolean: {},
        scoreDistFilter: null,
        latencyDistFilter: null,
        complexityFilter: null,
        domainFilter: null,
        rootCauseFilter: null,
        complexityValues: [],
        domainValues: [],
        rootCauseValues: [],
        allMetadataKeys: [],
        visibleMetadataFields: {},
        visibleMetricMetaFields: {},
        allMetricMetaKeys: [],
        langfuseHost: '',
        langfuseProjectId: '',
      };

      const el = (id) => document.getElementById(id);

      // ── Utility functions ──

      function parseMetaList(val) {
        if (val == null || val === '') return [];
        if (Array.isArray(val)) return val.filter(v => v != null && v !== 'null' && v !== '').map(String);
        var s = String(val).trim();
        if (s.startsWith('[') && s.endsWith(']')) {
          try { var p = JSON.parse(s); if (Array.isArray(p)) return p.filter(v => v != null).map(String); } catch {}
          try { var f = s.replace(/'/g, '"').replace(/"null"/g, 'null'); var p2 = JSON.parse(f); if (Array.isArray(p2)) return p2.filter(v => v != null).map(String); } catch {}
        }
        return [s];
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
      }

      function escapeAttr(text) {
        return String(text ?? '')
          .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      }

      function scoreColorClass(value) {
        if (value >= 0.9) return 'score-5';
        if (value >= 0.75) return 'score-4';
        if (value >= 0.6) return 'score-3';
        if (value >= 0.4) return 'score-2';
        return 'score-1';
      }

      function getSuccessClass(rate) {
        if (rate >= 0.9) return 'score-5';
        if (rate >= 0.75) return 'score-4';
        if (rate >= 0.6) return 'score-3';
        if (rate >= 0.4) return 'score-2';
        return 'score-1';
      }

      function infoIcon(tooltip) {
        return '<span class="stat-info-icon">i<span class="stat-info-tooltip">' + tooltip + '</span></span>';
      }

      function formatTaskStart(ms) {
        if (!ms || ms <= 0) return null;
        try {
          const d = new Date(ms);
          const pad = (n) => String(n).padStart(2, '0');
          return { ts: d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds()) };
        } catch { return null; }
      }

      function buildLangfuseTraceUrl(traceId) {
        if (!traceId || !state.langfuseHost || !state.langfuseProjectId) return null;
        const host = state.langfuseHost.replace(/\/$/, '');
        return host + '/project/' + state.langfuseProjectId + '/traces/' + traceId;
      }

      function csvEscape(val) {
        if (val.includes(',') || val.includes('"') || val.includes('\n')) {
          return '"' + val.replace(/"/g, '""') + '"';
        }
        return val;
      }

      function stringify(val) {
        if (val === null || val === undefined) return '';
        if (typeof val === 'object') return JSON.stringify(val);
        return String(val);
      }

      function computePercentiles(values, percentiles) {
        if (!values.length) return percentiles.map(() => 0);
        const sorted = [...values].sort((a, b) => a - b);
        return percentiles.map(p => {
          const idx = (p / 100) * (sorted.length - 1);
          const lo = Math.floor(idx);
          const hi = Math.ceil(idx);
          if (lo === hi) return sorted[lo];
          return sorted[lo] + (sorted[hi] - sorted[lo]) * (idx - lo);
        });
      }

      function isRTL(text) {
        var rtlChars = (text.match(/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/g) || []).length;
        var latinChars = (text.match(/[A-Za-z]/g) || []).length;
        return rtlChars > latinChars;
      }

      function renderMarkdownSafe(value) {
        if (value === null || value === undefined) return '&mdash;';
        if (typeof value === 'object') return formatObjectAsHtml(value);
        const str = String(value).replace(/\\u([0-9a-fA-F]{4})/g, (_, hex) => String.fromCharCode(parseInt(hex, 16)));
        const trimmed = str.trim();
        if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
          try { const p = JSON.parse(trimmed); if (typeof p === 'object' && p !== null) return formatObjectAsHtml(p); } catch {}
          const p = parsePythonDict(trimmed);
          if (p !== null) return formatObjectAsHtml(p);
        }
        let html = escapeHtml(str);
        html = html.replace(/```([\s\S]*?)```/g, '<pre style="background:var(--bg-elevated);padding:4px 8px;border-radius:4px;overflow-x:auto;margin:4px 0;">$1</pre>');
        html = html.replace(/`([^`]+)`/g, '<code style="background:var(--bg-elevated);padding:1px 4px;border-radius:3px;">$1</code>');
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:var(--accent-primary);">$1</a>');
        if (isRTL(str)) html = '<div dir="rtl" style="text-align:right;">' + html + '</div>';
        return html;
      }

      function parsePythonDict(str) {
        try {
          let i = 0; const len = str.length;
          function skip() { while (i < len && /\s/.test(str[i])) i++; }
          function parseVal() {
            skip(); if (i >= len) return undefined;
            const ch = str[i];
            if (ch === "'" || ch === '"') return parseStr(ch);
            if (ch === '{') return parseObj();
            if (ch === '[') return parseArr();
            return parseLit();
          }
          function parseStr(q) {
            i++; let r = '';
            while (i < len) {
              if (str[i] === '\\' && i+1 < len) { const n = str[i+1]; if (n==='n'){r+='\n';i+=2;} else if(n==='t'){r+='\t';i+=2;} else if(n==='\\'){r+='\\';i+=2;} else if(n===q){r+=q;i+=2;} else {r+=str[i];i++;} }
              else if (str[i] === q) { i++; return r; }
              else { r += str[i]; i++; }
            }
            return r;
          }
          function parseObj() {
            i++; const o = {}; skip(); if (str[i]==='}'){i++;return o;}
            while (i<len) { skip(); const k=parseVal(); if (typeof k!=='string') return null; skip(); if(str[i]!==':') return null; i++; o[k]=parseVal(); skip(); if(str[i]==='}'){i++;return o;} if(str[i]===','){i++;continue;} return null; }
            return o;
          }
          function parseArr() {
            i++; const a=[]; skip(); if(str[i]===']'){i++;return a;}
            while (i<len) { a.push(parseVal()); skip(); if(str[i]===']'){i++;return a;} if(str[i]===','){i++;continue;} return null; }
            return a;
          }
          function parseLit() {
            if (str.slice(i,i+4)==='True'){i+=4;return true;}
            if (str.slice(i,i+5)==='False'){i+=5;return false;}
            if (str.slice(i,i+4)==='None'){i+=4;return null;}
            let n=''; while(i<len && /[0-9.\-+eE]/.test(str[i])){n+=str[i];i++;}
            if(n){const v=parseFloat(n);if(!isNaN(v))return v;}
            return undefined;
          }
          return parseVal();
        } catch { return null; }
      }

      function fmtStr(s) {
        var escaped = escapeHtml(s);
        return isRTL(s) ? '<span class="formatted-string" dir="rtl" style="text-align:right;display:block;">' + escaped + '</span>' : '<span class="formatted-string">' + escaped + '</span>';
      }

      function formatObjectAsHtml(obj) {
        if (Array.isArray(obj)) {
          if (!obj.length) return '<span class="formatted-array">[]</span>';
          return '<div class="formatted-array">' + obj.map((item, idx) => {
            let f; if (item===null||item===undefined) f='<span class="formatted-null">null</span>'; else if (typeof item==='object') f=formatObjectAsHtml(item); else if (typeof item==='string') f=fmtStr(item); else f=escapeHtml(String(item));
            return '<div class="formatted-array-item"><span class="formatted-index">['+idx+']</span> '+f+'</div>';
          }).join('') + '</div>';
        }
        const entries = Object.entries(obj);
        if (!entries.length) return '<span class="formatted-object">{}</span>';
        return '<div class="formatted-object">' + entries.map(([k,v]) => {
          let f; if(v===null||v===undefined) f='<span class="formatted-null">null</span>'; else if(typeof v==='object') f=formatObjectAsHtml(v); else if(typeof v==='string') f=fmtStr(v); else if(typeof v==='number') f='<span class="formatted-number">'+v+'</span>'; else if(typeof v==='boolean') f='<span class="formatted-boolean">'+v+'</span>'; else f=escapeHtml(String(v));
          return '<div class="formatted-row"><span class="formatted-key">'+escapeHtml(k)+'</span>'+f+'<button class="copy-btn" data-copy-text="'+escapeAttr(String(v??''))+'" title="Copy '+escapeHtml(k)+'">'+COPY_ICON+'</button></div>';
        }).join('') + '</div>';
      }

      function formatFieldName(name) {
        return name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
      }

      function formatMetaValue(val) {
        if (val === undefined || val === null || val === '') return '';
        if (typeof val === 'boolean') return escapeHtml(String(val));
        if (typeof val === 'number') return escapeHtml(String(val));
        if (typeof val === 'string') return escapeHtml(val);
        if (Array.isArray(val)) {
          if (val.length === 0) return '[]';
          var isTabular = val.every(function(r) { return Array.isArray(r); });
          if (isTabular) {
            var colCount = Math.max.apply(null, val.map(function(r) { return r.length; }));
            var headerRow = colCount <= 10
              ? '<tr>' + Array.from({length: colCount}, function(_, i) { return '<th>Col ' + (i + 1) + '</th>'; }).join('') + '</tr>'
              : '';
            var bodyRows = val.map(function(r) {
              return '<tr>' + Array.from({length: colCount}, function(_, i) {
                var c = i < r.length ? r[i] : '';
                return '<td>' + escapeHtml(String(c == null ? '' : c)) + '</td>';
              }).join('') + '</tr>';
            }).join('');
            var tableHtml = '<table class="meta-table">' + (headerRow ? '<thead>' + headerRow + '</thead>' : '') + '<tbody>' + bodyRows + '</tbody></table>';
            if (val.length > 5) {
              var uid = 'mt_' + Math.random().toString(36).slice(2, 8);
              return '<div class="meta-table-wrapper collapsed" id="' + uid + '">' + tableHtml + '</div><button class="meta-table-toggle" onclick="var w=document.getElementById(\'' + uid + '\');w.classList.toggle(\'collapsed\');this.textContent=w.classList.contains(\'collapsed\')?\'Show all ' + val.length + ' rows \u25BC\':\'Show less \u25B2\';">Show all ' + val.length + ' rows \u25BC</button>';
            }
            return tableHtml;
          }
          var isFlatPrimitive = val.every(function(v) { return v === null || typeof v !== 'object'; });
          if (isFlatPrimitive) return escapeHtml(val.map(function(v) { return String(v == null ? '' : v); }).join(', '));
          return formatObjectAsHtml(val);
        }
        if (typeof val === 'object') return formatObjectAsHtml(val);
        return escapeHtml(String(val));
      }

      function showToast(type, title, message) {
          const container = el('toast-container');
          if (!container) return;
          const toast = document.createElement('div');
          toast.className = `toast toast-${type}`;
          toast.innerHTML = `
              <div class="toast-icon">${type === 'success' ? '✓' : '✗'}</div>
              <div class="toast-content">
                  <div class="toast-title">${escapeHtml(title)}</div>
                  <div class="toast-message">${escapeHtml(message)}</div>
              </div>
              <button class="toast-close" onclick="this.parentElement.remove()">×</button>
          `;
          container.appendChild(toast);
          setTimeout(() => {
              toast.classList.add('toast-exit');
              setTimeout(() => toast.remove(), 300);
          }, 4000);
      }

      // ── Data loading ──

      async function loadRunData() {
        if (!RUN_ID) { showEmpty(); return; }
        try {
          const res = await fetch(apiUrl('api/runs/' + RUN_ID));
          if (!res.ok) { showError('HTTP ' + res.status, 'Could not load run data.'); return; }
          const data = await res.json();
          if (data.error) { showError('Error', data.error); return; }
          if (!data.run || !data.snapshot) { showEmpty(); return; }
          state.run = data.run;
          state.snapshot = data.snapshot;
          state.langfuseHost = data.run.langfuse_host || '';
          state.langfuseProjectId = data.run.langfuse_project_id || '';
          processRun();
          render();
        } catch (err) {
          console.error('Failed to load run:', err);
          showError('Network Error', 'Could not connect to the server.');
        }
      }

      function processRun() {
        const run = state.run;
        const snap = state.snapshot;
        state.allMetrics = snap.metric_names || run.metric_names || [];
        if (state.allMetrics.length > 0 && !state.selectedMetric) {
          state.selectedMetric = state.allMetrics[0];
        }

        // Detect metric types
        for (const metricName of state.allMetrics) {
          let allBoolean = true;
          const mIdx = state.allMetrics.indexOf(metricName);
          for (const row of (snap.rows || [])) {
            const v = (row.metric_values || [])[mIdx];
            const n = window.QymMetrics.parseScoreValue(v);
            if (n !== null && Math.abs(n) > 0.0001 && Math.abs(n - 1) > 0.0001) {
              allBoolean = false; break;
            }
          }
          state.metricIsBoolean[metricName] = allBoolean;
          if (!state.metricThresholds[metricName]) {
            state.metricThresholds[metricName] = 0.8;
          }
        }

        // Collect metadata
        const metaKeySet = new Set();
        const complexitySet = new Set();
        const domainSet = new Set();
        const rootCauseSet = new Set();
        for (const row of (snap.rows || [])) {
          const md = row.item_metadata || {};
          if (typeof md === 'object') {
            for (const k of Object.keys(md)) { if (k !== 'task_started_at_ms') metaKeySet.add(k); }
            if (md.complexity != null && md.complexity !== '') complexitySet.add(String(md.complexity));
            if (md.domain != null && md.domain !== '') {
              for (const d of parseMetaList(md.domain)) domainSet.add(d);
            }
            if (md.root_cause != null && md.root_cause !== '') rootCauseSet.add(String(md.root_cause));
          }
        }
        state.allMetadataKeys = Array.from(metaKeySet).sort();
        const cOrder = ['easy', 'medium', 'hard'];
        state.complexityValues = Array.from(complexitySet).sort((a, b) => {
          const ai = cOrder.indexOf(a.toLowerCase()); const bi = cOrder.indexOf(b.toLowerCase());
          return (ai===-1?999:ai) - (bi===-1?999:bi);
        });
        state.domainValues = Array.from(domainSet).sort();
        state.rootCauseValues = Array.from(rootCauseSet).sort();

        for (const k of state.allMetadataKeys) {
          if (state.visibleMetadataFields[k] === undefined) state.visibleMetadataFields[k] = true;
        }

        // Collect metric metadata keys
        const mmKeySet = new Set();
        for (const row of (snap.rows || [])) {
          const mm = row.metric_meta || {};
          for (const metricName of Object.keys(mm)) {
            const meta = mm[metricName] || {};
            for (const k of Object.keys(meta)) {
              if (!['modified', 'original_score'].includes(k)) mmKeySet.add(k);
            }
          }
        }
        state.allMetricMetaKeys = Array.from(mmKeySet).sort();
        for (const k of state.allMetricMetaKeys) {
          if (state.visibleMetricMetaFields[k] === undefined) state.visibleMetricMetaFields[k] = true;
        }

        // Update header
        const config = run.config || {};
        el('hdr-run-name').textContent = run.run_name || '—';
        el('hdr-dataset').textContent = run.dataset_name || '—';
        el('hdr-model').textContent = config.model || config.model_name || '—';
        el('hdr-total').textContent = (snap.stats || {}).total || (snap.rows || []).length;
        el('hdr-metrics').textContent = state.allMetrics.length;

        const statusText = (run.status || 'unknown').toUpperCase();
        const statusEl = el('hdr-status');
        statusEl.textContent = statusText;

        document.title = '\u0642\u064A\u0651\u0650\u0645 \u2022 ' + (run.run_name || 'Run Detail');
      }

      function showEmpty() {
        el('loading').style.display = 'none';
        el('empty').style.display = 'flex';
        el('run-content').style.display = 'none';
      }

      function showError(title, msg) {
        el('loading').style.display = 'none';
        el('error-state').style.display = 'flex';
        el('error-title').textContent = title;
        el('error-message').textContent = msg;
        el('run-content').style.display = 'none';
      }

      // ── Rendering ──

      function render() {
        el('loading').style.display = 'none';
        el('empty').style.display = 'none';
        el('error-state').style.display = 'none';
        el('run-content').style.display = 'block';

        renderSummary();
        populateMetricSelectors();
        renderOverview();
        renderErrorAnalysis();
        renderMetadataBreakdown();
        buildCategoryDropdowns();
        populateMetadataFieldsDropdown();
        populateMetricMetaFieldsDropdown();
        renderItems();
        initAnalyzePanel();
      }

      function renderSummary() {
        const run = state.run;
        const config = run.config || {};
        const metadata = run.metadata || {};

        el('run-subtitle').textContent = run.run_name || '—';

        const configColors = ['var(--accent-primary)', 'var(--accent-secondary)', 'var(--accent-tertiary)', 'var(--chart-4)', 'var(--chart-5)'];
        let configHtml = '';
        if (config && typeof config === 'object' && Object.keys(config).length > 0) {
          const entries = Object.entries(config).filter(([k]) => k !== 'run_name');
          if (entries.length > 0) {
            configHtml = '<div class="hero-config">' + entries.map(([k,v], i) => {
              const color = configColors[i % configColors.length];
              return '<div class="config-cell">' +
                '<span class="config-cell-dot" style="background:' + color + '"></span>' +
                '<div class="config-cell-text">' +
                  '<div class="config-cell-key">' + escapeHtml(k) + '</div>' +
                  '<div class="config-cell-val" title="' + escapeAttr(String(v ?? '')) + '">' + escapeHtml(String(v ?? '')) + '</div>' +
                '</div>' +
              '</div>';
            }).join('') + '</div>';
          }
        }

        let langfuseHtml = '';
        const lfUrl = metadata?.langfuse_url;
        if (lfUrl) {
          langfuseHtml = '<a href="' + escapeAttr(lfUrl) + '" target="_blank" class="langfuse-link">Langfuse &#8599;</a>';
        } else if (state.langfuseHost && state.langfuseProjectId) {
          const url = state.langfuseHost.replace(/\/$/, '') + '/project/' + state.langfuseProjectId;
          langfuseHtml = '<a href="' + escapeAttr(url) + '" target="_blank" class="langfuse-link">Langfuse &#8599;</a>';
        }

        const statusClass = (run.status || '').toLowerCase();
        const statusText = escapeHtml((run.status || 'unknown').toUpperCase());

        // Summary pills (items, success rate, errors) for the hero card
        let summaryPills = '';
        const snap = state.snapshot || {};
        const snapStats = snap.stats || {};
        const total = snapStats.total || (snap.rows || []).length;
        const completed = snapStats.completed || 0;
        const failed = snapStats.failed || 0;
        const successRate = total > 0 ? completed / total : 0;
        if (total > 0) {
          summaryPills += '<span class="summary-pill">' + total + ' items</span>';
          const srClass = successRate >= 0.95 ? ' pill-success' : (successRate >= 0.8 ? ' pill-warn' : ' pill-error');
          summaryPills += '<span class="summary-pill' + srClass + '">' + formatPercent(successRate) + ' success</span>';
          if (failed > 0) summaryPills += '<span class="summary-pill pill-error">' + failed + ' error' + (failed !== 1 ? 's' : '') + '</span>';
        }

        el('run-summary').innerHTML = '<div class="run-summary-card">' +
          '<div class="hero-top">' +
            '<div class="hero-identity">' +
              '<div class="hero-run-name">' + escapeHtml(run.run_name || '—') + '</div>' +
              '<div class="hero-tags">' +
                '<span class="tag task">' + escapeHtml(run.dataset_name || '—') + '</span>' +
                langfuseHtml +
                summaryPills +
              '</div>' +
            '</div>' +
            '<div class="hero-status ' + statusClass + '"><span class="hero-status-dot"></span>' + statusText + '</div>' +
          '</div>' +
          configHtml +
        '</div>';
      }

      function populateMetricSelectors() {
        const singleMetric = state.allMetrics.length <= 1;

        // Threshold slider (in filter panel)
        const thresholdSlider = el('threshold-slider');
        if (thresholdSlider) {
          thresholdSlider.addEventListener('input', (e) => {
            const v = parseFloat(e.target.value);
            el('threshold-value').textContent = v + '%';
          });
          thresholdSlider.addEventListener('change', (e) => {
            const v = parseFloat(e.target.value);
            if (!isNaN(v) && v >= 0 && v <= 100) {
              state.metricThresholds[state.selectedMetric] = v / 100;
              renderOverview();
              renderMetadataBreakdown();
              state.page = 1;
              renderItems();
            }
          });
        }
        updateThresholdControl();

        // Items metric select
        const sel = el('items-metric-select');
        const grp = el('fp-metric-group');
        if (sel) {
          if (singleMetric) {
            if (grp) grp.style.display = 'none';
          } else {
            if (grp) grp.style.display = '';
            sel.innerHTML = state.allMetrics.map(m =>
              '<option value="' + escapeAttr(m) + '" ' + (m === state.selectedMetric ? 'selected' : '') + '>' + escapeHtml(m) + '</option>'
            ).join('');
            sel.addEventListener('change', (e) => {
              state.selectedMetric = e.target.value;
              state.scoreDistFilter = null;
              state.page = 1;
              updateThresholdControl();
              renderMetadataBreakdown();
              renderItems();
            });
          }
        }
      }

      function updateThresholdControl() {
        const tg = el('fp-threshold-group');
        const ts = el('threshold-slider');
        const tv = el('threshold-value');
        if (!tg || !ts) return;
        const metric = state.selectedMetric;
        if (!metric || state.metricIsBoolean[metric]) {
          tg.style.display = 'none';
        } else {
          tg.style.display = '';
          const pct = Math.round((state.metricThresholds[metric] ?? 0.8) * 100);
          ts.value = pct;
          if (tv) tv.textContent = pct + '%';
        }
      }

      function buildKpiHtml() {
        if (!state.snapshot) return '';
        const rows = state.snapshot.rows || [];

        // Compute per-metric averages
        const metricStats = {};
        for (const m of state.allMetrics) {
          const mi = state.allMetrics.indexOf(m);
          let sum = 0, cnt = 0;
          for (const row of rows) {
            const { score } = window.QymMetrics.getRowScore(row, mi);
            if (score !== null) { sum += score; cnt++; }
          }
          metricStats[m] = cnt > 0 ? sum / cnt : 0;
        }

        const stats = state.snapshot.stats || {};
        const total = stats.total || rows.length;
        const completed = stats.completed || 0;
        const failed = stats.failed || 0;
        const successRate = total > 0 ? completed / total : 0;

        let boxes = state.allMetrics.map(m => {
          const v = metricStats[m];
          return '<div class="stat-box"><div class="stat-title">' + escapeHtml(m) + '</div><div class="stat-main ' + scoreColorClass(v) + '">' + formatPercent(v) + '</div></div>';
        }).join('');

        boxes += '<div class="stat-box"><div class="stat-title">Success Rate</div><div class="stat-main ' + scoreColorClass(successRate) + '">' + formatPercent(successRate) + '</div><div class="stat-detail">' + completed + ' / ' + total + '</div></div>';
        boxes += '<div class="stat-box"><div class="stat-title">Items</div><div class="stat-main">' + total + '</div></div>';
        if (failed > 0) boxes += '<div class="stat-box"><div class="stat-title">Errors</div><div class="stat-main score-1">' + failed + '</div></div>';

        return '<div class="overview-kpis">' + boxes + '</div>';
      }

      function computeScoreDistribution(metric) {
        const rows = state.snapshot.rows || [];
        const mIdx = state.allMetrics.indexOf(metric);
        if (mIdx < 0) return [];
        const buckets = new Array(11).fill(0); // 0%, 10%, 20%, ..., 100%
        for (const row of rows) {
          const { score } = window.QymMetrics.getRowScore(row, mIdx);
          if (score === null) continue;
          const pct = Math.round(score * 100);
          const bucket = Math.min(10, Math.floor(pct / 10));
          buckets[bucket]++;
        }
        return buckets;
      }

      function getDistSegmentColor(bucketIdx) {
        // Per-bucket gradient using qym score palette (0%=red -> 100%=green)
        const colors = [
          'var(--score-1)',    // 0%
          'var(--score-1)',    // 10%
          '#f97316',           // 20%
          'var(--score-2)',    // 30%
          '#d4a017',           // 40%
          'var(--score-3)',    // 50%
          '#a3b818',           // 60%
          'var(--score-4)',    // 70%
          'var(--score-4)',    // 80%
          'var(--score-5)',    // 90%
          'var(--accent-primary)', // 100%
        ];
        return colors[Math.min(bucketIdx, colors.length - 1)];
      }

      function buildLatencyBuckets(latencies) {
        if (!latencies || latencies.length === 0) return [];
        const sorted = [...latencies].sort((a, b) => a - b);
        const minMs = sorted[0];
        const maxMs = sorted[sorted.length - 1];
        if (maxMs - minMs < 1) {
          return [{ label: formatLatBucketLabel(0, null), min: 0, max: Infinity, color: 'var(--accent-primary)' }];
        }

        // Use percentile-based boundaries to ensure bars are well-distributed
        // Target ~6 buckets using p10, p25, p50, p75, p90 as boundaries
        const pctls = [0, 15, 35, 55, 75, 90, 100];
        const rawEdges = pctls.map(p => {
          const idx = (p / 100) * (sorted.length - 1);
          const lo = Math.floor(idx), hi = Math.ceil(idx);
          return lo === hi ? sorted[lo] : sorted[lo] + (sorted[hi] - sorted[lo]) * (idx - lo);
        });

        // Snap to nice round numbers
        const snap = (ms) => {
          if (ms <= 100) return Math.round(ms / 10) * 10;
          if (ms <= 1000) return Math.round(ms / 50) * 50;
          if (ms <= 5000) return Math.round(ms / 250) * 250;
          if (ms <= 30000) return Math.round(ms / 1000) * 1000;
          if (ms <= 120000) return Math.round(ms / 5000) * 5000;
          return Math.round(ms / 10000) * 10000;
        };

        // Build unique edges, dedup after snapping
        const edges = [0]; // always start at 0
        for (let i = 1; i < rawEdges.length - 1; i++) {
          const snapped = snap(rawEdges[i]);
          if (snapped > edges[edges.length - 1]) edges.push(snapped);
        }

        const buckets = [];
        for (let i = 0; i < edges.length; i++) {
          const min = edges[i];
          const max = i < edges.length - 1 ? edges[i + 1] : Infinity;
          buckets.push({ min, max, label: formatLatBucketLabel(min, max === Infinity ? null : max) });
        }
        if (buckets.length === 0) {
          buckets.push({ min: 0, max: Infinity, label: 'all' });
        }

        // Assign colors: gradient green → red
        const colorStops = ['var(--score-5)', 'var(--score-4)', 'var(--score-3)', 'var(--score-2)', 'var(--score-1)'];
        for (let i = 0; i < buckets.length; i++) {
          const t = buckets.length > 1 ? i / (buckets.length - 1) : 0;
          const ci = Math.min(colorStops.length - 1, Math.round(t * (colorStops.length - 1)));
          buckets[i].color = colorStops[ci];
        }
        return buckets;
      }

      function formatLatBucketLabel(minMs, maxMs) {
        const fmt = (ms) => {
          if (ms >= 60000) return (ms / 60000).toFixed(ms % 60000 === 0 ? 0 : 1) + 'm';
          if (ms >= 1000) return (ms / 1000).toFixed(ms % 1000 === 0 ? 0 : 1) + 's';
          return ms + 'ms';
        };
        if (maxMs === null) return fmt(minMs) + '+';
        return fmt(minMs) + '-' + fmt(maxMs);
      }

      function renderOverview() {
        const section = el('overview-section');
        if (!section || !state.snapshot) { if (section) section.innerHTML = ''; return; }
        const rows = state.snapshot.rows || [];
        const stats = state.snapshot.stats || {};
        const total = stats.total || rows.length;
        const completed = stats.completed || 0;
        const failed = stats.failed || 0;
        const successRate = total > 0 ? completed / total : 0;

        // ── Gauge color (hex for conic-gradient) ──
        function gaugeColorHex(score) {
          if (score >= 0.9) return '#10b981';
          if (score >= 0.75) return '#84cc16';
          if (score >= 0.6) return '#eab308';
          if (score >= 0.4) return '#f97316';
          return '#ef4444';
        }

        function buildGaugeRing(score) {
          const color = gaugeColorHex(score);
          const deg = (score * 360).toFixed(1);
          return '<div class="gauge-ring" style="background:conic-gradient(' + color + ' 0deg ' + deg + 'deg, #252536 ' + deg + 'deg 360deg);">' +
            '<div class="gauge-ring-inner"></div>' +
          '</div>';
        }

        // ── Metric cards (gauge + histogram) ──
        let cards = '';
        const MAX_BAR_PX = 100;

        for (const metric of state.allMetrics) {
          const mIdx = state.allMetrics.indexOf(metric);
          let sum = 0, cnt = 0;
          for (const row of rows) {
            const { score } = window.QymMetrics.getRowScore(row, mIdx);
            if (score !== null) { sum += score; cnt++; }
          }
          const avg = cnt > 0 ? sum / cnt : 0;

          const buckets = computeScoreDistribution(metric);
          const totalWithScores = buckets.reduce((a,b) => a+b, 0);
          if (totalWithScores === 0) continue;

          const maxCount = Math.max(...buckets);
          let barsHtml = '<div class="dist-chart">';
          for (let b = 0; b <= 10; b++) {
            const count = buckets[b];
            const barH = maxCount > 0 ? Math.max(count > 0 ? 3 : 0, Math.round((count / maxCount) * MAX_BAR_PX)) : 0;
            const color = getDistSegmentColor(b);
            const label = (b * 10) + '%';
            const rangeMin = b / 10;
            const rangeMax = b === 10 ? 1.01 : (b + 1) / 10;
            const pct = totalWithScores > 0 ? ((count / totalWithScores) * 100).toFixed(0) : '0';
            barsHtml += '<div class="dist-chart-col" data-metric="' + escapeAttr(metric) + '" data-bucket-min="' + rangeMin + '" data-bucket-max="' + rangeMax + '" title="' + label + ': ' + count + ' items (' + pct + '%)">' +
              '<span class="bar-count">' + (count > 0 ? count : '') + '</span>' +
              '<div class="bar-fill" style="height:' + barH + 'px;background:' + color + ';"></div>' +
              '<span class="bar-label">' + label + '</span>' +
            '</div>';
          }
          barsHtml += '</div>';

          cards += '<div class="metric-card">' +
            '<div class="metric-card-header">' +
              '<div class="metric-card-gauge">' +
                buildGaugeRing(avg) +
                '<div class="metric-card-info">' +
                  '<div class="metric-card-value ' + scoreColorClass(avg) + '">' + formatPercent(avg) + '</div>' +
                  '<div class="metric-card-name">' + escapeHtml(metric) + '</div>' +
                '</div>' +
              '</div>' +
              '<span class="metric-card-badge">' + totalWithScores + ' scored</span>' +
            '</div>' +
            barsHtml +
          '</div>';
        }

        // ── Latency card ──
        const latencies = rows.filter(r => r.latency_ms && r.latency_ms > 0 && r.status === 'completed').map(r => r.latency_ms);
        if (latencies.length > 0) {
          const sorted = [...latencies].sort((a, b) => a - b);
          const minLat = sorted[0];
          const maxLat = sorted[sorted.length - 1];
          const latTotal = latencies.length;
          const [p50, p90, p99] = computePercentiles(latencies, [50, 90, 99]);
          const meanLat = latencies.reduce((a, b) => a + b, 0) / latTotal;

          const latBuckets = buildLatencyBuckets(latencies);
          const counts = latBuckets.map(() => 0);
          for (const lat of latencies) {
            for (let i = 0; i < latBuckets.length; i++) {
              if (lat >= latBuckets[i].min && lat < latBuckets[i].max) { counts[i]++; break; }
              if (i === latBuckets.length - 1) counts[i]++;
            }
          }
          const maxCount = Math.max(...counts);

          let barsHtml = '<div class="dist-chart">';
          for (let i = 0; i < latBuckets.length; i++) {
            const count = counts[i];
            const barH = maxCount > 0 ? Math.max(count > 0 ? 3 : 0, Math.round((count / maxCount) * MAX_BAR_PX)) : 0;
            const pct = latTotal > 0 ? ((count / latTotal) * 100).toFixed(0) : '0';
            barsHtml += '<div class="dist-chart-col" data-lat-min="' + latBuckets[i].min + '" data-lat-max="' + latBuckets[i].max + '" title="' + latBuckets[i].label + ': ' + count + ' items (' + pct + '%)">' +
              '<span class="bar-count">' + (count > 0 ? count : '') + '</span>' +
              '<div class="bar-fill" style="height:' + barH + 'px;background:' + latBuckets[i].color + ';"></div>' +
              '<span class="bar-label">' + latBuckets[i].label + '</span>' +
            '</div>';
          }
          barsHtml += '</div>';

          cards += '<div class="metric-card">' +
            '<div class="metric-card-header">' +
              '<div class="metric-card-gauge">' +
                '<div class="latency-badge"><span class="latency-badge-icon">\u23F1</span></div>' +
                '<div class="metric-card-info">' +
                  '<div class="metric-card-value" style="color:var(--accent-secondary);">' + formatLatency(p50) + '</div>' +
                  '<div class="metric-card-name">Latency \u00B7 P50</div>' +
                '</div>' +
              '</div>' +
              '<div class="latency-stats-compact">' +
                '<span>Min <b>' + formatLatency(minLat) + '</b></span>' +
                '<span>Mean <b>' + formatLatency(meanLat) + '</b></span>' +
                '<span>P90 <b>' + formatLatency(p90) + '</b></span>' +
                '<span>P99 <b>' + formatLatency(p99) + '</b></span>' +
                '<span>Max <b>' + formatLatency(maxLat) + '</b></span>' +
              '</div>' +
            '</div>' +
            barsHtml +
          '</div>';
        }

        // ── Assemble ──
        section.innerHTML =
          '<div class="overview-header">' +
            '<div><h3 class="section-title">Overview</h3>' +
            '<div class="overview-header-hint">Score distributions per metric and response latency. Click any bar to filter the item table.</div></div>' +
          '</div>' +
          (cards ? '<div class="metric-cards-grid">' + cards + '</div>' : '');

        // ── Wire click handlers ──
        const grid = section.querySelector('.metric-cards-grid');
        if (!grid) return;

        grid.querySelectorAll('.dist-chart-col[data-bucket-min]').forEach(col => {
          col.addEventListener('click', () => {
            const metric = col.dataset.metric;
            const min = parseFloat(col.dataset.bucketMin);
            const max = parseFloat(col.dataset.bucketMax);
            if (metric && metric !== state.selectedMetric) {
              state.selectedMetric = metric;
              const sel = el('items-metric-select');
              if (sel) sel.value = metric;
              updateThresholdControl();
            }
            state.scoreDistFilter = { min, max };
            state.page = 1;
            renderItems();
          });
        });

        grid.querySelectorAll('.dist-chart-col[data-lat-min]').forEach(col => {
          col.addEventListener('click', () => {
            const min = parseFloat(col.dataset.latMin);
            const max = col.dataset.latMax === 'Infinity' ? Infinity : parseFloat(col.dataset.latMax);
            state.latencyDistFilter = { min, max };
            state.page = 1;
            renderItems();
          });
        });
      }

      function renderErrorAnalysis() {
        const section = el('error-analysis-section');
        const container = el('error-analysis-container');
        if (!section || !container) return;
        const rows = state.snapshot.rows || [];
        const stats = state.snapshot.stats || {};
        const total = stats.total || rows.length;
        const failed = stats.failed || 0;

        if (failed === 0) { section.style.display = 'none'; return; }
        section.style.display = '';

        let timeout = 0, runtime = 0, unknown = 0;
        for (const row of rows) {
          if (window.QymMetrics.isErrorRow(row)) {
            const output = (row.output_full || row.output || '').toLowerCase();
            if (output.includes('timeout')) timeout++;
            else if (output.includes('error')) runtime++;
            else unknown++;
          }
        }

        const pct = total > 0 ? ((failed / total) * 100).toFixed(1) : '0.0';

        container.innerHTML =
          '<div class="stats-row-flex">' +
            '<div class="stat-box"><div class="stat-title">Total Errors</div><div class="stat-main score-1">' + failed + ' / ' + total + '</div><div class="stat-detail">' + pct + '% error rate</div></div>' +
            '<div class="stat-box"><div class="stat-title">Timeout</div><div class="stat-main ' + (timeout > 0 ? 'score-1' : '') + '">' + timeout + '</div></div>' +
            '<div class="stat-box"><div class="stat-title">Runtime</div><div class="stat-main ' + (runtime > 0 ? 'score-1' : '') + '">' + runtime + '</div></div>' +
            '<div class="stat-box"><div class="stat-title">Unknown</div><div class="stat-main ' + (unknown > 0 ? 'score-2' : '') + '">' + unknown + '</div></div>' +
          '</div>';
      }

      function renderMetadataBreakdown() {
        const breakdownKeys = ['complexity', 'domain'].filter(k => state.allMetadataKeys.includes(k));
        breakdownKeys.push('root_cause');
        const section = el('metadata-breakdown');
        if (!section) return;
        if (breakdownKeys.length === 0) { section.innerHTML = ''; return; }

        const metric = state.selectedMetric || state.allMetrics[0];
        if (!metric) return;
        const mIdx = state.allMetrics.indexOf(metric);
        const isBoolean = state.metricIsBoolean[metric];
        const rows = state.snapshot.rows || [];

        let html = '<h3 class="section-title">Performance by Category</h3><div class="comparison-stats">';

        for (const bdKey of breakdownKeys) {
          const groups = {};
          for (const row of rows) {
            const md = row.item_metadata || {};
            const rawVal = md[bdKey] ?? '';
            const groupVals = (bdKey === 'domain' || bdKey === 'patterns')
              ? parseMetaList(rawVal)
              : [String(rawVal)];
            if (groupVals.length === 0) groupVals.push('');
            for (const groupVal of groupVals) {
              if (bdKey === 'root_cause' && !groupVal) continue;
              const effective = groupVal || 'unknown';
              if (!groups[effective]) groups[effective] = { scores: [], latencies: [], count: 0 };
              groups[effective].count++;
              if (mIdx >= 0) {
                const { score } = window.QymMetrics.getRowScore(row, mIdx);
                if (score !== null) groups[effective].scores.push(score);
              }
              if (row.latency_ms && row.status === 'completed') {
                groups[effective].latencies.push(row.latency_ms);
              }
            }
          }

          const threshold = isBoolean ? 0.9999 : (state.metricThresholds[metric] || 0.8);
          const groupStats = Object.entries(groups).map(([gv, g]) => {
            const passCount = g.scores.filter(s => s >= threshold).length;
            return {
              groupVal: gv,
              itemCount: g.count,
              avgScore: g.scores.length > 0 ? g.scores.reduce((a,b)=>a+b,0) / g.scores.length : 0,
              passRate: g.scores.length > 0 ? passCount / g.scores.length : 0,
              avgLatency: g.latencies.length > 0 ? g.latencies.reduce((a,b)=>a+b,0) / g.latencies.length : null,
            };
          });

          if (bdKey === 'complexity') {
            const co = ['easy','medium','hard'];
            groupStats.sort((a,b) => {
              const ai = co.indexOf(a.groupVal.toLowerCase().trim());
              const bi = co.indexOf(b.groupVal.toLowerCase().trim());
              return (ai===-1?999:ai) - (bi===-1?999:bi);
            });
          } else if (bdKey === 'root_cause') {
            groupStats.sort((a,b) => b.itemCount - a.itemCount);
          } else {
            groupStats.sort((a,b) => a.groupVal.localeCompare(b.groupVal));
          }

          if (groupStats.length === 0 && bdKey !== 'root_cause') continue;

          const icon = bdKey === 'complexity' ? '\u2666' : bdKey === 'root_cause' ? '\u26A0' : '\u25C6';
          const colorClass = bdKey === 'complexity' ? 'breakdown-complexity' : bdKey === 'root_cause' ? 'breakdown-root-cause' : 'breakdown-domain';
          const displayName = bdKey === 'root_cause' ? 'Root Cause Analysis' : bdKey.charAt(0).toUpperCase() + bdKey.slice(1);

          html += '<div class="breakdown-section ' + colorClass + '">';
          if (bdKey === 'root_cause') {
            html += '<div class="breakdown-header"><span class="breakdown-icon">' + icon + '</span> ' + escapeHtml(displayName) + ' <button class="auto-analyze-btn" id="auto-analyze-btn" title="AI-powered root cause analysis" style="margin-left:12px;"><span class="ai-icon">🤖</span> Auto-Analyze</button></div>';
            html += '<div id="analyze-panel-slot"></div>';
          } else {
            html += '<div class="breakdown-header"><span class="breakdown-icon">' + icon + '</span> ' + escapeHtml(displayName) + ' <span class="breakdown-metric">' + escapeHtml(metric) + '</span></div>';
          }
          html += '<div class="breakdown-grid">';

          for (const g of groupStats) {
            if (bdKey === 'root_cause') {
              const rcColor = ROOT_CAUSE_COLORS[g.groupVal] || '#e07a5f';
              html += '<div class="breakdown-card" data-bd-category="' + escapeAttr(bdKey) + '" data-bd-value="' + escapeAttr(g.groupVal) + '" style="cursor:pointer;"><div class="breakdown-card-label" style="color:' + rcColor + ';">' + escapeHtml(g.groupVal) + '</div><div class="breakdown-card-score" style="color:' + rcColor + ';">' + g.itemCount + '</div></div>';
            } else {
              const latStr = g.avgLatency !== null ? formatLatency(g.avgLatency) : '&mdash;';
              let cardValClass = '';
              if (bdKey === 'complexity') {
                const cv = g.groupVal.toLowerCase().trim();
                if (['easy','simple','basic','low'].includes(cv)) cardValClass = ' complexity-easy';
                else if (['medium','moderate','intermediate','mid'].includes(cv)) cardValClass = ' complexity-medium';
                else if (['hard','difficult','advanced','high','complex'].includes(cv)) cardValClass = ' complexity-hard';
                else if (['very hard','very_hard','expert','extreme'].includes(cv)) cardValClass = ' complexity-expert';
              }
              html += '<div class="breakdown-card' + cardValClass + '" data-bd-category="' + escapeAttr(bdKey) + '" data-bd-value="' + escapeAttr(g.groupVal) + '" style="cursor:pointer;">' +
                '<div class="breakdown-card-label" title="' + escapeAttr(g.groupVal) + '">' + escapeHtml(g.groupVal) + '</div>' +
                '<div class="breakdown-card-scores"><div class="score-col"><span class="score-col-label">Average</span><span class="score-col-value ' + scoreColorClass(g.avgScore) + '">' + formatPercent(g.avgScore) + '</span></div><div class="score-col" style="margin-left:auto;"><span class="score-col-label">Items</span><span class="score-col-value" style="color:var(--text-muted);">' + g.itemCount + '</span></div></div>' +
                '<div class="breakdown-card-details"><span class="breakdown-detail"><span class="breakdown-detail-label">Latency</span> ' + latStr + '</span></div></div>';
            }
          }
          html += '</div></div>';
        }

        html += '</div>';
        section.innerHTML = html;

        // Wire breakdown card click-to-filter
        section.querySelectorAll('.breakdown-card[data-bd-category]').forEach(card => {
          card.addEventListener('click', () => {
            const cat = card.dataset.bdCategory;
            const val = card.dataset.bdValue;
            const current = getCatFilter(cat);
            // Toggle: if already filtering to just this value, clear the filter
            if (current !== null && current.length === 1 && current[0] === val) {
              setCatFilter(cat, null);
            } else {
              setCatFilter(cat, [val]);
            }
            syncMultiselectUI(cat);
            state.page = 1;
            renderItems();
          });
        });

        // Move analyze panel into the root cause section
        const slot = document.getElementById('analyze-panel-slot');
        const panel = el('analyze-panel');
        if (slot && panel) slot.appendChild(panel);

        // Re-wire auto-analyze button after re-render
        if (_analyzeConfigCache) wireAnalyzeButton(_analyzeConfigCache);
      }

      // ── Filtering & Items ──

      function getFilteredItems() {
        const rows = state.snapshot.rows || [];
        const metric = state.selectedMetric;
        const mIdx = metric ? state.allMetrics.indexOf(metric) : -1;
        const isBoolean = metric ? state.metricIsBoolean[metric] : false;
        const threshold = isBoolean ? 0.9999 : (state.metricThresholds[metric] || 0.8);
        let items = [];

        for (const row of rows) {
          // Search filter
          if (state.searchQuery) {
            const q = state.searchQuery.toLowerCase();
            const inp = String(row.input_full || row.input || '').toLowerCase();
            const exp = String(row.expected_full || row.expected || '').toLowerCase();
            const out = String(row.output_full || row.output || '').toLowerCase();
            if (!inp.includes(q) && !exp.includes(q) && !out.includes(q)) continue;
          }

          // Category filters
          const md = (typeof row.item_metadata === 'object') ? row.item_metadata : {};
          if (state.complexityFilter !== null) {
            if (state.complexityFilter.length === 0) continue;
            const val = String(md.complexity ?? '').toLowerCase();
            if (!state.complexityFilter.some(f => f.toLowerCase() === val)) continue;
          }
          if (state.domainFilter !== null) {
            if (state.domainFilter.length === 0) continue;
            const domainVals = parseMetaList(md.domain).map(v => v.toLowerCase());
            if (!state.domainFilter.some(f => domainVals.includes(f.toLowerCase()))) continue;
          }
          if (state.rootCauseFilter !== null) {
            if (state.rootCauseFilter.length === 0) continue;
            const rcVal = String(md.root_cause ?? '');
            const wantNone = state.rootCauseFilter.includes('__none__');
            const namedFilters = state.rootCauseFilter.filter(f => f !== '__none__');
            const matchesNamed = namedFilters.length > 0 && namedFilters.some(f => f.toLowerCase() === rcVal.toLowerCase());
            const matchesNone = wantNone && !rcVal;
            if (!matchesNamed && !matchesNone) continue;
          }

          // Score for this metric
          let score = null;
          if (mIdx >= 0) {
            const result = window.QymMetrics.getRowScore(row, mIdx);
            score = result.score;
          }

          // Item filter
          if (state.itemFilter === 'passed') {
            if (score === null || score < threshold) continue;
          } else if (state.itemFilter === 'failed') {
            if (score === null || score >= threshold) continue;
          } else if (state.itemFilter === 'errors') {
            if (!window.QymMetrics.isErrorRow(row)) continue;
          }

          // Score distribution filter
          if (state.scoreDistFilter) {
            if (score === null) continue;
            if (score < state.scoreDistFilter.min || score >= state.scoreDistFilter.max) continue;
          }

          // Latency distribution filter
          if (state.latencyDistFilter) {
            const lat = row.latency_ms || 0;
            if (lat < state.latencyDistFilter.min || lat >= state.latencyDistFilter.max) continue;
          }

          items.push({ row, score });
        }

        // Sorting
        if (state.sortBy === 'score_asc') {
          items.sort((a, b) => (a.score ?? -1) - (b.score ?? -1));
        } else if (state.sortBy === 'score_desc') {
          items.sort((a, b) => (b.score ?? -1) - (a.score ?? -1));
        } else if (state.sortBy === 'latency_asc') {
          items.sort((a, b) => (a.row.latency_ms || 0) - (b.row.latency_ms || 0));
        } else if (state.sortBy === 'latency_desc') {
          items.sort((a, b) => (b.row.latency_ms || 0) - (a.row.latency_ms || 0));
        }
        // default: index order (already sorted)

        return items;
      }

      function renderItems(scrollToTop) {
        const container = el('items-grid');
        const paginationEl = el('pagination');
        const filterCountEl = el('filter-count');
        const items = getFilteredItems();
        const metric = state.selectedMetric;
        const mIdx = metric ? state.allMetrics.indexOf(metric) : -1;
        const isBoolean = metric ? state.metricIsBoolean[metric] : false;
        const threshold = isBoolean ? 0.9999 : (state.metricThresholds[metric] || 0.8);

        filterCountEl.innerHTML = 'Showing <span class="count-num">' + items.length + '</span> items';
        updateClearButton();

        const totalPages = Math.max(1, Math.ceil(items.length / state.pageSize));
        if (state.page > totalPages) state.page = totalPages;
        const start = (state.page - 1) * state.pageSize;
        const pageItems = items.slice(start, start + state.pageSize);

        if (items.length === 0) {
          container.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-muted);">No items match the current filter</div>';
          paginationEl.innerHTML = '';
          return;
        }

        container.innerHTML = pageItems.map(({ row }) => {
          const input = row.input_full || row.input || '\u2014';
          const expected = row.expected_full || row.expected || '';
          const output = row.output_full || row.output || '\u2014';
          const status = row.status || 'pending';
          const latencyMs = row.latency_ms;
          const taskStartedAtMs = row.task_started_at_ms;
          const traceId = row.trace_id;
          const traceUrl = row.trace_url || buildLangfuseTraceUrl(traceId);
          const metricVals = row.metric_values || [];
          const metricMeta = row.metric_meta || {};
          const itemId = row.item_id || String(row.index);
          const safeId = btoa(itemId).replace(/[+/=]/g, '_');

          // Display item ID
          let displayItemId = itemId;
          const itemMatch = itemId.match(/^item_(\d+)$/);
          if (itemMatch) displayItemId = 'Item ' + (parseInt(itemMatch[1], 10) + 1);

          // Metric scores inline
          const metricScoresHtml = state.allMetrics.map((name, i) => {
            const sv = metricVals[i];
            const v = window.QymMetrics.parseScoreValue(sv);
            if (v === null) return '';
            const cls = getSuccessClass(v);
            const isSelected = name === metric;
            const meta = metricMeta[name] || {};
            const editBtn = '<button class="metric-edit-open" data-row-index="' + escapeAttr(String(row.index ?? 0)) + '" data-metric="' + escapeAttr(name) + '" title="Edit">\u270E</button>';
            const editedBadge = String(meta.modified || '').toLowerCase() === 'true' ? '<span class="metric-edit-badge">Edited</span>' : '';
            return '<div class="metric-score-row ' + (isSelected ? 'highlighted' : '') + '"><span class="metric-score-name">' + escapeHtml(name) + '</span><span class="metric-score-meta"><span class="metric-score-value ' + cls + '">' + formatPercent(v) + '</span>' + editBtn + editedBadge + '</span></div>';
          }).join('');

          // Metric edit blocks
          let metricEditHtml = state.allMetrics.map((name, i) => {
            const rawScore = metricVals[i];
            const rawValue = (rawScore == null || rawScore === '') ? '' : String(rawScore);
            const meta = metricMeta[name] || {};
            const originalRaw = meta.original_score;
            const hasOriginal = !(originalRaw == null || originalRaw === '');
            const modifiedNote = hasOriginal ? '<div class="metric-edit-meta">Original: ' + escapeHtml(String(originalRaw)) + '</div>' : '';
            return '<div class="metric-edit-block hidden" data-row-index="' + escapeAttr(String(row.index ?? 0)) + '" data-metric="' + escapeAttr(name) + '"><div class="metric-edit-title">Edit ' + escapeHtml(name) + '_score</div><div class="metric-edit-controls"><input class="metric-edit-input" type="text" value="' + escapeAttr(rawValue) + '" data-row-index="' + escapeAttr(String(row.index ?? 0)) + '" data-metric="' + escapeAttr(name) + '" /><button class="metric-edit-save" data-row-index="' + escapeAttr(String(row.index ?? 0)) + '" data-metric="' + escapeAttr(name) + '">Save</button><span class="metric-edit-status"></span></div>' + modifiedNote + '</div>';
          }).join('');

          // Latency badge
          const latencyBadge = latencyMs ? '<span class="latency-badge">\u23F1' + formatLatency(latencyMs) + '</span>' : '';
          // Start badge
          const startInfo = formatTaskStart(taskStartedAtMs);
          const startBadge = startInfo ? '<span class="start-badge" title="' + escapeAttr(startInfo.ts) + '">' + escapeHtml(startInfo.ts) + '</span>' : '';
          // Trace link
          const traceLink = traceUrl ? '<a href="' + escapeAttr(traceUrl) + '" target="_blank" class="trace-link">Langfuse \u2197</a>' : '';

          // Pass/fail badge
          let passfailBadge = '';
          if (status === 'error') {
            passfailBadge = '<span class="passfail-badge fail">Fail</span>';
          } else if (metric && mIdx >= 0) {
            const pfVal = window.QymMetrics.parseScoreValue(metricVals[mIdx]);
            if (pfVal !== null) {
              passfailBadge = pfVal >= threshold ? '<span class="passfail-badge pass">Pass</span>' : '<span class="passfail-badge fail">Fail</span>';
            }
          }

          // Root cause + feedback (only for failed items)
          let rootCauseHtml = '';
          const itemPassed = passfailBadge.includes('badge pass"');
          const rowRc = row.item_metadata?.root_cause || '';
          const rowRcNote = row.item_metadata?.root_cause_note || '';
          if (rowRc) {
            const feedbackIcon = '<svg class="feedback-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 3h12v8H4l-2 2V3z"/></svg>';
            var feedbackHtml = rowRcNote
              ? '<div class="feedback-section"><div class="feedback-display" data-feedback-item="' + escapeAttr(itemId) + '" title="Click to edit feedback">' + feedbackIcon + '<span class="feedback-text">' + escapeHtml(rowRcNote) + '</span></div></div>'
              : '<div class="feedback-section"><div class="feedback-display" data-feedback-item="' + escapeAttr(itemId) + '" title="Click to add feedback">' + feedbackIcon + '<span class="feedback-text feedback-placeholder">Add feedback\u2026</span></div></div>';
            const rcColor = ROOT_CAUSE_COLORS[rowRc] || '#e07a5f';
            const rcSource = row.item_metadata?.root_cause_source || '';
            const rcConfidence = row.item_metadata?.root_cause_confidence;
            const isAi = rcSource === 'ai';
            const aiClass = isAi ? ' ai-suggested' : '';
            const sourceIcon = isAi ? '<span class="ai-indicator">🤖</span>' : '<span class="badge-icon">✓</span>';
            let confidenceDot = '';
            if (isAi && rcConfidence != null) {
              const dotColor = rcConfidence >= 0.8 ? '#22c55e' : (rcConfidence >= 0.5 ? '#eab308' : '#ef4444');
              confidenceDot = '<span class="confidence-dot" style="background:' + dotColor + ';" title="Confidence: ' + (rcConfidence * 100).toFixed(0) + '%"></span>';
            }
            rootCauseHtml = '<div class="root-cause-row"><span class="meta-badge badge-root-cause' + aiClass + '" data-rc-item="' + escapeAttr(itemId) + '" style="border-color:' + rcColor + '40;color:' + rcColor + ';background:' + rcColor + '15;" title="Root cause: ' + escapeAttr(rowRc) + (isAi ? ' (AI-suggested)' : '') + '. Click to change.">' + sourceIcon + escapeHtml(rowRc) + confidenceDot + '</span>' + feedbackHtml + '</div>';
          } else if (!itemPassed) {
            rootCauseHtml = '<div class="root-cause-row"><button class="root-cause-assign-btn" data-rc-item="' + escapeAttr(itemId) + '" title="Assign root cause"><span class="badge-icon">+</span>Root Cause</button></div>';
          }

          // Metric details
          let metricDetailsHtml = '';
          const hasMetricMeta = Object.keys(metricMeta).length > 0;
          if (hasMetricMeta) {
            const detailRows = state.allMetrics.map(name => {
              const meta = metricMeta[name] || {};
              const metaKeys = Object.keys(meta).filter(k => !['modified','original_score'].includes(k) && state.visibleMetricMetaFields[k] !== false);
              if (!metaKeys.length) return '';
              return metaKeys.map(key => {
                const val = meta[key];
                if (val === undefined || val === null || val === '') return '';
                return '<div class="metric-detail-row"><span class="metric-detail-name">' + escapeHtml(name) + ' \u00B7 ' + formatFieldName(key) + '</span><span class="metric-detail-value">' + formatMetaValue(val) + '</span></div>';
              }).join('');
            }).join('');
            if (detailRows) {
              metricDetailsHtml = '<div class="run-metric-details" data-item="' + safeId + '">' + detailRows + '</div>';
            }
          }
          const toggleHtml = metricDetailsHtml ? '<button class="metric-details-toggle" onclick="window._toggleDetails(\'' + safeId + '\')"><span class="toggle-icon" id="toggle-icon-' + safeId + '">\u25B6</span> Metric Details</button>' : '';

          // Item metadata badges
          let itemMetadataHtml = '';
          const SPECIAL_KEYS = ['complexity', 'domain', 'root_cause', 'root_cause_note', 'root_cause_source', 'root_cause_confidence'];
          const itemMd = row.item_metadata || {};
          if (typeof itemMd === 'object') {
            let badgesHtml = '';
            for (const sk of SPECIAL_KEYS) {
              if (sk.startsWith('root_cause')) continue;
              if (itemMd[sk] != null && itemMd[sk] !== '' && state.visibleMetadataFields[sk] !== false) {
                const icon = sk === 'complexity' ? '\u2666' : '\u25C6';
                const vals = (sk === 'domain' || sk === 'patterns') ? parseMetaList(itemMd[sk]) : [String(itemMd[sk])];
                for (const v of vals) {
                  let valClass = '';
                  if (sk === 'complexity') {
                    const lv = v.toLowerCase().trim();
                    if (['easy','simple','basic','low'].includes(lv)) valClass = ' complexity-easy';
                    else if (['medium','moderate','intermediate','mid'].includes(lv)) valClass = ' complexity-medium';
                    else if (['hard','difficult','advanced','high','complex'].includes(lv)) valClass = ' complexity-hard';
                    else if (['very hard','very_hard','expert','extreme'].includes(lv)) valClass = ' complexity-expert';
                  }
                  badgesHtml += '<span class="meta-badge badge-' + sk + valClass + '"><span class="badge-icon">' + icon + '</span>' + escapeHtml(v) + '</span>';
                }
              }
            }
            const genericEntries = Object.entries(itemMd).filter(([k]) => k !== 'task_started_at_ms' && !SPECIAL_KEYS.includes(k) && state.visibleMetadataFields[k] !== false);
            let genericHtml = genericEntries.map(([k,v]) => '<span class="item-metadata-tag"><span class="meta-key">' + escapeHtml(k) + ':</span> <span class="meta-val">' + escapeHtml(String(v)) + '</span></span>').join('');
            if (badgesHtml || genericHtml) {
              const sep = badgesHtml && genericHtml ? '<span class="item-meta-sep"></span>' : '';
              itemMetadataHtml = '<div class="item-metadata-row">' + (badgesHtml ? '<div class="item-meta-badges">' + badgesHtml + '</div>' : '') + sep + (genericHtml ? '<div class="item-metadata-tags">' + genericHtml + '</div>' : '') + '</div>';
            }
          }

          return '<div class="item-card">' +
            '<div class="item-header"><span class="item-index" title="ID: ' + escapeHtml(itemId) + '">#' + (row.index + 1) + '</span><span style="font-size:var(--font-xs);color:var(--text-muted);">(' + escapeHtml(displayItemId) + ')</span><button class="copy-btn" data-item-id="' + escapeAttr(itemId) + '" title="Copy all fields">' + COPY_ICON + '</button></div>' +
            '<div class="item-input-row"><div class="input-label">INPUT <button class="copy-btn" data-copy-text="' + escapeAttr(typeof input === 'object' ? JSON.stringify(input,null,2) : String(input)) + '" title="Copy input">' + COPY_ICON + '</button></div><div class="input-text">' + renderMarkdownSafe(input) + '</div></div>' +
            (expected ? '<div class="item-expected-row"><div class="expected-label">EXPECTED OUTPUT <button class="copy-btn" data-copy-text="' + escapeAttr(typeof expected === 'object' ? JSON.stringify(expected,null,2) : String(expected)) + '" title="Copy expected">' + COPY_ICON + '</button></div><div class="expected-text collapsed">' + renderMarkdownSafe(expected) + '</div><button class="expected-toggle" onclick="this.previousElementSibling.classList.toggle(\'collapsed\'); this.textContent = this.previousElementSibling.classList.contains(\'collapsed\') ? \'Show more \u25BC\' : \'Show less \u25B2\';">Show more \u25BC</button></div>' : '') +
            itemMetadataHtml +
            '<div class="item-run-output"><div class="output-header"><span class="run-label">OUTPUT</span><span class="output-badges">' + passfailBadge + '<button class="copy-btn" data-copy-text="' + escapeAttr(typeof output === 'object' ? JSON.stringify(output,null,2) : String(output)) + '" title="Copy output">' + COPY_ICON + '</button>' + startBadge + latencyBadge + traceLink + '</span></div><div class="output-text ' + (status === 'error' ? 'score-1' : '') + '">' + renderMarkdownSafe(output) + '</div><div class="metric-scores-inline">' + metricScoresHtml + '</div>' + metricEditHtml + rootCauseHtml + toggleHtml + metricDetailsHtml + '</div>' +
          '</div>';
        }).join('');

        // Pagination
        paginationEl.innerHTML = '<button id="prev-page" ' + (state.page <= 1 ? 'disabled' : '') + '>&larr; Prev</button><span class="page-info">Page ' + state.page + ' of ' + totalPages + '</span><button id="next-page" ' + (state.page >= totalPages ? 'disabled' : '') + '>Next &rarr;</button>';
        el('prev-page').onclick = () => { state.page--; renderItems(true); };
        el('next-page').onclick = () => { state.page++; renderItems(true); };

        if (scrollToTop) container.scrollIntoView({ behavior: 'smooth', block: 'start' });

        wireMetricEditHandlers();
        wireRootCauseHandlers();
        wireCopyHandlers();
        initExpectedToggles();
      }

      // ── Metric edit handlers ──

      async function updateMetricScore(filePath, rowIndex, metricName, newScore) {
        const res = await fetch(apiUrl('api/runs/update_metric'), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file_path: filePath, row_index: rowIndex, metric_name: metricName, new_score: newScore }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.error) throw new Error(data.error || 'Failed to update metric');
        return data;
      }

      function applyUpdatedRow(updatedRow) {
        try {
          const rows = state.snapshot.rows || [];
          const idx = Number(updatedRow.index) || 0;
          if (idx >= 0 && idx < rows.length) { rows[idx] = updatedRow; }
          else { const pos = rows.findIndex(r => Number(r.index) === idx); if (pos >= 0) rows[pos] = updatedRow; }
        } catch {}
      }

      function wireMetricEditHandlers() {
        document.querySelectorAll('.metric-edit-open').forEach(btn => {
          btn.onclick = () => {
            const rowIndex = btn.dataset.rowIndex;
            const metric = btn.dataset.metric;
            const block = document.querySelector('.metric-edit-block[data-row-index="' + rowIndex + '"][data-metric="' + metric + '"]');
            if (!block) return;
            const isHidden = block.classList.contains('hidden');
            block.classList.toggle('hidden');
            btn.textContent = isHidden ? '\u2715' : '\u270E';
          };
        });
        document.querySelectorAll('.metric-edit-save').forEach(btn => {
          btn.onclick = async () => {
            const rowIndex = Number(btn.dataset.rowIndex);
            const metricName = btn.dataset.metric || '';
            const controls = btn.closest('.metric-edit-controls');
            const input = controls ? controls.querySelector('.metric-edit-input') : null;
            const statusEl = controls ? controls.querySelector('.metric-edit-status') : null;
            const filePath = state.run?.file_path || '';
            if (!filePath || !metricName || !input) { if (statusEl) statusEl.textContent = 'Unavailable'; return; }
            btn.disabled = true;
            if (statusEl) statusEl.textContent = 'Saving...';
            try {
              const result = await updateMetricScore(filePath, rowIndex, metricName, input.value);
              if (result && result.row) {
                applyUpdatedRow(result.row);
                renderOverview();
                renderMetadataBreakdown();
                renderItems();
              }
            } catch (err) {
              if (statusEl) statusEl.textContent = 'Error';
            } finally {
              btn.disabled = false;
              if (statusEl && statusEl.textContent === 'Saving...') statusEl.textContent = '';
            }
          };
        });
      }

      // ── Root cause + feedback handlers ──

      function wireRootCauseHandlers() {
        document.querySelectorAll('[data-rc-item]:not([data-feedback-item])').forEach(trigger => {
          trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            showRootCauseDropdown(trigger.dataset.rcItem, trigger);
          });
        });
        document.querySelectorAll('[data-feedback-item]').forEach(trigger => {
          trigger.addEventListener('click', function(e) {
            e.stopPropagation();
            var itemId = trigger.dataset.feedbackItem;
            var rows = state.snapshot.rows || [];
            var row = rows.find(function(r) { return (r.item_id || String(r.index)) === itemId; });
            var currentNote = row?.item_metadata?.root_cause_note || '';
            var section = trigger.closest('.feedback-section');
            if (!section) return;
            section.innerHTML = '<div class="feedback-edit"><textarea placeholder="Add feedback\u2026">' + escapeHtml(currentNote) + '</textarea><div class="feedback-edit-actions"><button class="feedback-btn feedback-btn-cancel">Cancel</button><button class="feedback-btn feedback-btn-save">Save</button></div></div>';
            var textarea = section.querySelector('textarea');
            var saveBtn = section.querySelector('.feedback-btn-save');
            var cancelBtn = section.querySelector('.feedback-btn-cancel');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            saveBtn.addEventListener('click', async function() {
              await saveFeedback(itemId, textarea.value.trim());
            });
            cancelBtn.addEventListener('click', function() {
              renderItems();
            });
            textarea.addEventListener('keydown', async function(ev) {
              if (ev.key === 'Enter' && !ev.shiftKey) {
                ev.preventDefault();
                await saveFeedback(itemId, textarea.value.trim());
              }
              if (ev.key === 'Escape') { renderItems(); }
            });
          });
        });
      }

      async function saveFeedback(itemId, note) {
        var runId = state.run?.file_path;
        if (!runId) return;
        try {
          var res = await fetch(apiUrl('api/runs/update_root_cause'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id: itemId, root_cause_note: note, run_id: runId }),
          });
          var data = await res.json().catch(function() { return {}; });
          if (!res.ok || data.error) { console.error('Failed to save feedback:', data.error); return; }
          var rows = state.snapshot.rows || [];
          var row = rows.find(function(r) { return (r.item_id || String(r.index)) === itemId; });
          if (row) {
            if (!row.item_metadata) row.item_metadata = {};
            if (note) row.item_metadata.root_cause_note = note;
            else delete row.item_metadata.root_cause_note;
          }
          renderItems();
          // Flash success indicator on the feedback section
          setTimeout(function() {
            var saved = document.querySelector('[data-feedback-item="' + itemId + '"]');
            if (saved) {
              var sec = saved.closest('.feedback-section');
              if (sec) { sec.classList.add('feedback-saved'); setTimeout(function() { sec.classList.remove('feedback-saved'); }, 800); }
            }
          }, 50);
        } catch (err) { console.error('Error saving feedback:', err); }
      }

      function showRootCauseDropdown(itemId, anchorEl) {
        document.querySelectorAll('.root-cause-dropdown').forEach(d => d.remove());
        const rows = state.snapshot.rows || [];
        const row = rows.find(r => (r.item_id || String(r.index)) === itemId);
        const currentRC = row?.item_metadata?.root_cause || '';
        const allOptions = [...ROOT_CAUSE_PRESETS];
        for (const v of state.rootCauseValues) { if (!allOptions.includes(v)) allOptions.push(v); }

        const dropdown = document.createElement('div');
        dropdown.className = 'root-cause-dropdown';
        let html = '<div class="rc-option ' + (!currentRC ? 'active' : '') + '" data-rc-value=""><span class="rc-dot" style="background:var(--text-muted);"></span> None (clear)</div>';
        html += '<div class="rc-divider"></div>';
        for (const opt of allOptions) {
          const color = ROOT_CAUSE_COLORS[opt] || '#e07a5f';
          html += '<div class="rc-option ' + (opt === currentRC ? 'active' : '') + '" data-rc-value="' + escapeAttr(opt) + '"><span class="rc-dot" style="background:' + color + ';"></span> ' + escapeHtml(opt) + '</div>';
        }
        html += '<div class="rc-divider"></div>';
        html += '<div class="rc-custom-input"><input type="text" placeholder="Custom cause..." /><button>Add</button></div>';
        dropdown.innerHTML = html;

        document.body.appendChild(dropdown);
        const rect = anchorEl.getBoundingClientRect();
        const dropH = dropdown.offsetHeight;
        const spaceBelow = window.innerHeight - rect.bottom - 8;
        const spaceAbove = rect.top - 8;
        if (spaceBelow >= dropH || spaceBelow >= spaceAbove) {
          dropdown.style.top = (rect.bottom + 4) + 'px';
        } else {
          dropdown.style.top = Math.max(4, rect.top - dropH - 4) + 'px';
        }
        dropdown.style.left = Math.min(rect.left, window.innerWidth - dropdown.offsetWidth - 8) + 'px';
        dropdown.style.maxHeight = Math.max(spaceBelow, spaceAbove) + 'px';

        dropdown.querySelectorAll('.rc-option').forEach(opt => {
          opt.addEventListener('click', async () => {
            await saveRootCause(itemId, opt.dataset.rcValue);
            dropdown.remove();
          });
        });

        const customInput = dropdown.querySelector('.rc-custom-input input');
        const customBtn = dropdown.querySelector('.rc-custom-input button');
        customBtn.addEventListener('click', async () => {
          const val = customInput.value.trim();
          if (val) { await saveRootCause(itemId, val); dropdown.remove(); }
        });
        customInput.addEventListener('keydown', async (e) => {
          if (e.key === 'Enter') {
            const val = customInput.value.trim();
            if (val) { await saveRootCause(itemId, val); dropdown.remove(); }
          }
        });

        const cleanup = () => {
          dropdown.remove();
          document.removeEventListener('click', closeHandler);
          window.removeEventListener('scroll', scrollHandler, true);
        };
        const closeHandler = (e) => {
          if (!dropdown.contains(e.target)) cleanup();
        };
        const scrollHandler = (e) => {
          if (!dropdown.contains(e.target)) cleanup();
        };
        setTimeout(() => {
          document.addEventListener('click', closeHandler);
          window.addEventListener('scroll', scrollHandler, true);
        }, 0);
      }

      async function saveRootCause(itemId, rootCause) {
        const runId = state.run?.file_path;
        if (!runId) return;
        try {
          const res = await fetch(apiUrl('api/runs/update_root_cause'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id: itemId, root_cause: rootCause, run_id: runId }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || data.error) { console.error('Failed to save root cause:', data.error); return; }

          const rows = state.snapshot.rows || [];
          const row = rows.find(r => (r.item_id || String(r.index)) === itemId);
          if (row) {
            if (!row.item_metadata) row.item_metadata = {};
            if (rootCause) { row.item_metadata.root_cause = rootCause; row.item_metadata.root_cause_source = 'human'; delete row.item_metadata.root_cause_confidence; } else { delete row.item_metadata.root_cause; delete row.item_metadata.root_cause_source; delete row.item_metadata.root_cause_confidence; }
          }
          if (rootCause && !state.rootCauseValues.includes(rootCause)) { state.rootCauseValues.push(rootCause); state.rootCauseValues.sort(); }
          if (rootCause && !state.allMetadataKeys.includes('root_cause')) { state.allMetadataKeys.push('root_cause'); state.allMetadataKeys.sort(); }

          renderMetadataBreakdown();
          buildCategoryDropdowns();
          renderItems();
        } catch (err) { console.error('Error saving root cause:', err); }
      }

      function initExpectedToggles() {
        document.querySelectorAll('.item-expected-row').forEach(function(row) {
          var text = row.querySelector('.expected-text');
          var btn = row.querySelector('.expected-toggle');
          if (!text || !btn) return;
          if (text.scrollHeight <= 100) {
            text.classList.remove('collapsed');
            btn.style.display = 'none';
          } else {
            btn.style.display = '';
          }
        });
      }

      // ── Copy handlers ──

      function wireCopyHandlers() {
        const container = el('items-grid');
        container.querySelectorAll('.copy-btn[data-item-id]').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.itemId;
            const rows = state.snapshot.rows || [];
            const row = rows.find(r => (r.item_id || String(r.index)) === id);
            if (!row) return;
            const parts = [];
            parts.push('Input: ' + (typeof row.input_full === 'object' ? JSON.stringify(row.input_full,null,2) : String(row.input_full || row.input || '')));
            const exp = row.expected_full || row.expected || '';
            if (exp) parts.push('Expected: ' + (typeof exp === 'object' ? JSON.stringify(exp,null,2) : String(exp)));
            parts.push('Output: ' + (typeof row.output_full === 'object' ? JSON.stringify(row.output_full,null,2) : String(row.output_full || row.output || '')));
            navigator.clipboard.writeText(parts.join('\n\n')).then(() => {
              btn.innerHTML = CHECK_ICON; btn.classList.add('copied');
              setTimeout(() => { btn.innerHTML = COPY_ICON; btn.classList.remove('copied'); }, 1500);
            });
          });
        });
        container.querySelectorAll('.copy-btn[data-copy-text]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            navigator.clipboard.writeText(btn.dataset.copyText).then(() => {
              btn.innerHTML = CHECK_ICON; btn.classList.add('copied');
              setTimeout(() => { btn.innerHTML = COPY_ICON; btn.classList.remove('copied'); }, 1500);
            });
          });
        });
      }

      // ── Metric details toggle ──

      window._toggleDetails = function(safeId) {
        const details = document.querySelectorAll('.run-metric-details[data-item="' + safeId + '"]');
        const icon = document.getElementById('toggle-icon-' + safeId);
        if (!details.length) return;
        const isExpanded = details[0].classList.contains('expanded');
        details.forEach(d => { if (isExpanded) d.classList.remove('expanded'); else d.classList.add('expanded'); });
        if (icon) icon.textContent = isExpanded ? '\u25B6' : '\u25BC';
      };

      // ── Category dropdowns ──

      function buildCategoryDropdowns() {
        const hasComplexity = state.complexityValues.length > 0;
        const hasDomain = state.domainValues.length > 0;
        const hasRootCause = state.rootCauseValues.length > 0;
        const hasMeta = hasComplexity || hasDomain || hasRootCause;
        el('fp-cat-complexity').style.display = hasComplexity ? '' : 'none';
        el('fp-cat-domain').style.display = hasDomain ? '' : 'none';
        el('fp-cat-root_cause').style.display = hasRootCause ? '' : 'none';
        el('fp-meta-fields').style.display = hasMeta ? '' : 'none';
        el('fp-metric-meta-fields').style.display = state.allMetricMetaKeys.length > 0 ? '' : 'none';
        if (hasComplexity) buildMultiselectOptions('complexity', state.complexityValues);
        if (hasDomain) buildMultiselectOptions('domain', state.domainValues);
        if (hasRootCause) buildMultiselectOptions('root_cause', state.rootCauseValues);
      }

      function buildMultiselectOptions(category, values) {
        const dropdown = el(category + '-ms-dropdown');
        if (!dropdown) return;
        const itemCounts = {};
        for (const v of values) itemCounts[v] = 0;
        const rows = state.snapshot.rows || [];
        for (const row of rows) {
          const md = row.item_metadata || {};
          const val = String(md[category] ?? '');
          if (itemCounts[val] !== undefined) itemCounts[val]++;
        }
        var extraOptions = '';
        if (category === 'root_cause') {
          var noRcCount = 0;
          for (var ri = 0; ri < rows.length; ri++) {
            var rmd = rows[ri].item_metadata || {};
            if (!rmd.root_cause) noRcCount++;
          }
          extraOptions = '<label class="multi-select-option" data-value="__none__"><input type="checkbox" data-cat="' + escapeAttr(category) + '" data-val="__none__" /><span style="font-style:italic;">(No Root Cause)</span><span class="option-count">' + noRcCount + '</span></label><div style="height:1px;background:var(--border-subtle);margin:2px 0;"></div>';
        }
        let html = '<div class="ms-actions"><button class="ms-action-btn" data-action="all" data-cat="' + escapeAttr(category) + '">Select All</button><button class="ms-action-btn" data-action="none" data-cat="' + escapeAttr(category) + '">Clear</button></div>';
        html += extraOptions + values.map(v =>
          '<label class="multi-select-option" data-value="' + escapeAttr(v) + '"><input type="checkbox" data-cat="' + escapeAttr(category) + '" data-val="' + escapeAttr(v) + '" /><span>' + escapeHtml(v) + '</span><span class="option-count">' + (itemCounts[v] || 0) + '</span></label>'
        ).join('');
        dropdown.innerHTML = html;

        dropdown.querySelectorAll('.multi-select-option input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', () => {
            let filterArr = getCatFilter(category);
            if (filterArr === null) { filterArr = [...values]; if (category === 'root_cause') filterArr.push('__none__'); setCatFilter(category, filterArr); }
            if (cb.checked) { if (!filterArr.includes(cb.dataset.val)) filterArr.push(cb.dataset.val); }
            else { const idx = filterArr.indexOf(cb.dataset.val); if (idx >= 0) filterArr.splice(idx, 1); }
            syncMultiselectUI(category);
            state.page = 1;
            renderItems();
          });
        });
        dropdown.querySelectorAll('.ms-action-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (btn.dataset.action === 'all') setCatFilter(category, null);
            else setCatFilter(category, []);
            syncMultiselectUI(category);
            state.page = 1;
            renderItems();
          });
        });
        syncMultiselectUI(category);
      }

      function getCatFilter(cat) {
        if (cat === 'complexity') return state.complexityFilter;
        if (cat === 'domain') return state.domainFilter;
        if (cat === 'root_cause') return state.rootCauseFilter;
        return null;
      }
      function setCatFilter(cat, val) {
        if (cat === 'complexity') state.complexityFilter = val;
        else if (cat === 'domain') state.domainFilter = val;
        else if (cat === 'root_cause') state.rootCauseFilter = val;
      }
      function getCatValues(cat) {
        if (cat === 'complexity') return state.complexityValues;
        if (cat === 'domain') return state.domainValues;
        if (cat === 'root_cause') return state.rootCauseValues;
        return [];
      }
      function getCatDefaultLabel(cat) {
        if (cat === 'complexity') return 'All Complexity';
        if (cat === 'domain') return 'All Domains';
        if (cat === 'root_cause') return 'All Root Causes';
        return 'All';
      }

      function syncMultiselectUI(category) {
        const filterArr = getCatFilter(category);
        const values = getCatValues(category);
        const defaultLabel = getCatDefaultLabel(category);
        const btn = el(category + '-ms-btn');
        const dropdown = el(category + '-ms-dropdown');

        const allCount = category === 'root_cause' ? values.length + 1 : values.length;
        if (filterArr !== null && filterArr.length >= allCount) setCatFilter(category, null);
        const effective = getCatFilter(category);

        if (btn) {
          if (effective === null) { btn.textContent = defaultLabel; btn.classList.remove('has-selection'); }
          else if (effective.length === 0) { btn.textContent = 'None'; btn.classList.add('has-selection'); }
          else if (effective.length === 1) { btn.textContent = effective[0] === '__none__' ? '(No Root Cause)' : effective[0]; btn.classList.add('has-selection'); }
          else { btn.textContent = effective.length + ' selected'; btn.classList.add('has-selection'); }
        }
        if (dropdown) {
          dropdown.querySelectorAll('.multi-select-option input[type="checkbox"]').forEach(cb => {
            cb.checked = effective === null || effective.includes(cb.dataset.val);
          });
        }
      }

      function setupCatDropdownToggle(category) {
        const btn = el(category + '-ms-btn');
        const dropdown = el(category + '-ms-dropdown');
        if (!btn || !dropdown) return;
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('.multi-select-dropdown.open').forEach(d => { if (d !== dropdown) d.classList.remove('open'); });
          el('metadata-fields-dropdown').classList.remove('open');
          el('metric-meta-fields-dropdown').classList.remove('open');
          dropdown.classList.toggle('open');
        });
        dropdown.addEventListener('click', (e) => e.stopPropagation());
      }

      setupCatDropdownToggle('complexity');
      setupCatDropdownToggle('domain');
      setupCatDropdownToggle('root_cause');
      document.addEventListener('click', () => {
        document.querySelectorAll('.fp-cat-group .multi-select-dropdown.open').forEach(d => d.classList.remove('open'));
      });

      // ── Metadata fields selector ──

      el('metadata-fields-btn').addEventListener('click', () => {
        el('metric-meta-fields-dropdown').classList.remove('open');
        document.querySelectorAll('.multi-select-dropdown.open').forEach(d => d.classList.remove('open'));
        el('metadata-fields-dropdown').classList.toggle('open');
      });
      el('metric-meta-fields-btn').addEventListener('click', () => {
        el('metadata-fields-dropdown').classList.remove('open');
        document.querySelectorAll('.multi-select-dropdown.open').forEach(d => d.classList.remove('open'));
        el('metric-meta-fields-dropdown').classList.toggle('open');
      });
      document.addEventListener('click', (e) => {
        var metaDd = el('metadata-fields-dropdown'), metaBtn = el('metadata-fields-btn');
        var mmDd = el('metric-meta-fields-dropdown'), mmBtn = el('metric-meta-fields-btn');
        if (metaDd && !metaDd.contains(e.target) && e.target !== metaBtn) metaDd.classList.remove('open');
        if (mmDd && !mmDd.contains(e.target) && e.target !== mmBtn) mmDd.classList.remove('open');
      });

      function populateMetadataFieldsDropdown() {
        const dropdown = el('metadata-fields-dropdown');
        if (!dropdown || state.allMetadataKeys.length === 0) {
          if (dropdown) dropdown.innerHTML = '<div style="padding:4px;color:var(--text-muted);font-size:var(--font-xs);">No metadata fields found</div>';
          return;
        }
        dropdown.innerHTML = state.allMetadataKeys.map(k => {
          const checked = state.visibleMetadataFields[k] ? 'checked' : '';
          return '<label><input type="checkbox" ' + checked + ' data-meta-key="' + escapeAttr(k) + '" /> ' + escapeHtml(k) + '</label>';
        }).join('');
        dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', () => {
            state.visibleMetadataFields[cb.dataset.metaKey] = cb.checked;
            renderItems();
          });
        });
      }

      function populateMetricMetaFieldsDropdown() {
        const dropdown = el('metric-meta-fields-dropdown');
        if (!dropdown || state.allMetricMetaKeys.length === 0) {
          if (dropdown) dropdown.innerHTML = '<div style="padding:4px;color:var(--text-muted);font-size:var(--font-xs);">No metric metadata fields found</div>';
          return;
        }
        dropdown.innerHTML = state.allMetricMetaKeys.map(k => {
          const checked = state.visibleMetricMetaFields[k] !== false ? 'checked' : '';
          return '<label><input type="checkbox" ' + checked + ' data-mm-key="' + escapeAttr(k) + '" /> ' + escapeHtml(formatFieldName(k)) + '</label>';
        }).join('');
        dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', () => {
            state.visibleMetricMetaFields[cb.dataset.mmKey] = cb.checked;
            renderItems();
          });
        });
      }

      // ── Clear filters ──

      function countActiveFilters() {
        let n = 0;
        if (state.itemFilter !== 'all') n++;
        if (state.sortBy !== 'index') n++;
        if (state.searchQuery) n++;
        if (state.complexityFilter !== null) n++;
        if (state.domainFilter !== null) n++;
        if (state.rootCauseFilter !== null) n++;
        if (state.scoreDistFilter) n++;
        if (state.latencyDistFilter) n++;
        return n;
      }

      function updateClearButton() {
        const clearBtn = el('clear-all-btn');
        const countBadge = el('active-filter-count');
        const n = countActiveFilters();
        if (clearBtn) clearBtn.classList.toggle('visible', n > 0);
        if (countBadge) countBadge.textContent = n;
      }

      function clearAllFilters() {
        state.itemFilter = 'all';
        state.sortBy = 'index';
        state.searchQuery = '';
        state.complexityFilter = null;
        state.domainFilter = null;
        state.rootCauseFilter = null;
        state.scoreDistFilter = null;
        state.latencyDistFilter = null;
        state.page = 1;
        el('item-filter').value = 'all';
        el('sort-select').value = 'index';
        el('items-search').value = '';
        syncMultiselectUI('complexity');
        syncMultiselectUI('domain');
        syncMultiselectUI('root_cause');
        renderItems();
      }

      el('clear-all-btn').addEventListener('click', clearAllFilters);

      // ── Event listeners ──

      el('item-filter').addEventListener('change', (e) => {
        state.itemFilter = e.target.value;
        state.page = 1;
        renderItems();
      });

      el('sort-select').addEventListener('change', (e) => {
        state.sortBy = e.target.value;
        state.page = 1;
        renderItems();
      });

      {
        let searchTimer = null;
        el('items-search').addEventListener('input', (e) => {
          clearTimeout(searchTimer);
          searchTimer = setTimeout(() => {
            state.searchQuery = e.target.value.trim();
            state.page = 1;
            renderItems();
          }, 250);
        });
      }

      // ── Export CSV with Column Selector ──

      var _exportItems = null;
      var _exportColumns = null;

      function tryParseObj(val) {
        if (val && typeof val === 'object' && !Array.isArray(val)) return val;
        if (typeof val === 'string') {
          var s = val.trim();
          if (s.startsWith('{') && s.endsWith('}')) {
            try { var p = JSON.parse(s); if (p && typeof p === 'object' && !Array.isArray(p)) return p; } catch {}
            try { var f = s.replace(/'/g, '"').replace(/True/g, 'true').replace(/False/g, 'false').replace(/None/g, 'null'); var p2 = JSON.parse(f); if (p2 && typeof p2 === 'object' && !Array.isArray(p2)) return p2; } catch {}
          }
        }
        return null;
      }

      function discoverExportColumns(items) {
        var groups = [];
        var outputKeys = new Set();
        var inputKeys = new Set();
        var expectedKeys = new Set();
        for (var i = 0; i < items.length; i++) {
          var r = items[i].row;
          var outObj = tryParseObj(r.output_full || r.output);
          if (outObj) { for (var k of Object.keys(outObj)) outputKeys.add(k); }
          var inpObj = tryParseObj(r.input_full || r.input);
          if (inpObj) { for (var k of Object.keys(inpObj)) inputKeys.add(k); }
          var expObj = tryParseObj(r.expected_full || r.expected);
          if (expObj) { for (var k of Object.keys(expObj)) expectedKeys.add(k); }
        }

        var coreColumns = [
          { key: '#', label: '# (row number)', checked: true },
          { key: 'item_id', label: 'Item ID', checked: true },
          { key: 'status', label: 'Status', checked: true },
          { key: 'input', label: inputKeys.size > 0 ? 'Input (raw)' : 'Input', checked: inputKeys.size === 0 },
          { key: 'expected', label: expectedKeys.size > 0 ? 'Expected Output (raw)' : 'Expected Output', checked: expectedKeys.size === 0 },
          { key: 'output', label: outputKeys.size > 0 ? 'Output (raw)' : 'Output', checked: outputKeys.size === 0 },
        ];
        groups.push({ group: 'Core Fields', columns: coreColumns });

        if (inputKeys.size > 0) {
          groups.push({ group: 'Input Fields', columns: Array.from(inputKeys).sort().map(function(k) {
            return { key: 'input.' + k, label: k, checked: true };
          }) });
        }
        if (expectedKeys.size > 0) {
          groups.push({ group: 'Expected Output Fields', columns: Array.from(expectedKeys).sort().map(function(k) {
            return { key: 'expected.' + k, label: k, checked: true };
          }) });
        }
        if (outputKeys.size > 0) {
          groups.push({ group: 'Output Fields', columns: Array.from(outputKeys).sort().map(function(k) {
            return { key: 'output.' + k, label: k, checked: true };
          }) });
        }

        // Item metadata
        var metaKeySet = new Set();
        for (var i = 0; i < items.length; i++) {
          var md = items[i].row.item_metadata || {};
          if (typeof md === 'object') {
            for (var k of Object.keys(md)) { if (k !== 'task_started_at_ms') metaKeySet.add(k); }
          }
        }
        if (metaKeySet.size > 0) {
          groups.push({ group: 'Item Metadata', columns: Array.from(metaKeySet).sort().map(function(k) {
            return { key: 'meta:' + k, label: k, checked: true };
          }) });
        }

        // Per-metric groups
        var metricMetaKeys = {};
        for (var m of state.allMetrics) metricMetaKeys[m] = new Set();
        for (var i = 0; i < items.length; i++) {
          var mm = items[i].row.metric_meta || {};
          for (var m of state.allMetrics) {
            var meta = mm[m] || {};
            for (var k of Object.keys(meta)) {
              if (!['modified', 'original_score'].includes(k)) metricMetaKeys[m].add(k);
            }
          }
        }
        for (var m of state.allMetrics) {
          var cols = [{ key: m + '_score', label: 'Score', checked: true }];
          for (var k of Array.from(metricMetaKeys[m]).sort()) {
            cols.push({ key: m + ':' + k, label: k, checked: true });
          }
          groups.push({ group: 'Metric: ' + m, columns: cols });
        }

        // Trace & Timing
        groups.push({ group: 'Trace & Timing', columns: [
          { key: 'latency_ms', label: 'Latency (ms)', checked: true },
          { key: 'trace_id', label: 'Trace ID', checked: true },
          { key: 'trace_url', label: 'Trace URL', checked: true },
        ] });

        return groups;
      }

      function renderExportModal(groups) {
        var overlay = document.getElementById('export-modal-overlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.id = 'export-modal-overlay';
          overlay.className = 'export-modal-overlay';
          document.body.appendChild(overlay);
        }
        var html = '<div class="export-modal"><div class="export-modal-header"><h3>Select Export Columns</h3><div class="export-modal-actions-top"><button id="export-select-all">Select All</button><button id="export-deselect-all">Deselect All</button></div></div><div class="export-modal-body">';
        for (var gi = 0; gi < groups.length; gi++) {
          var g = groups[gi];
          html += '<div class="export-group"><div class="export-group-header" data-group="' + gi + '"><span class="group-toggle">\u25BC</span><span class="group-name">' + escapeHtml(g.group) + '</span><input type="checkbox" class="group-check" data-group="' + gi + '" checked /></div><div class="export-group-items" data-group="' + gi + '">';
          for (var ci = 0; ci < g.columns.length; ci++) {
            var col = g.columns[ci];
            var chk = col.checked ? ' checked' : '';
            var cls = col.indent ? ' indent' : '';
            html += '<label class="export-col-item' + cls + '"><input type="checkbox" data-group="' + gi + '" data-col="' + ci + '"' + chk + ' /> ' + escapeHtml(col.label) + '</label>';
          }
          html += '</div></div>';
        }
        html += '</div><div class="export-modal-footer"><span style="flex:1;font-size:var(--font-xs);color:var(--text-muted);font-family:var(--font-mono);">' + _exportItems.length + ' item' + (_exportItems.length !== 1 ? 's' : '') + '</span><button class="export-cancel" id="export-modal-cancel">Cancel</button><button class="export-confirm" id="export-modal-confirm">Export</button></div></div>';
        overlay.innerHTML = html;

        // Wire group header toggle (collapse/expand)
        overlay.querySelectorAll('.export-group-header').forEach(function(hdr) {
          hdr.addEventListener('click', function(e) {
            if (e.target.type === 'checkbox') return;
            var gi = hdr.dataset.group;
            var items = overlay.querySelector('.export-group-items[data-group="' + gi + '"]');
            var toggle = hdr.querySelector('.group-toggle');
            items.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
          });
        });

        // Wire group checkbox (check/uncheck all in group)
        overlay.querySelectorAll('.group-check').forEach(function(gc) {
          gc.addEventListener('change', function() {
            var gi = gc.dataset.group;
            overlay.querySelectorAll('input[data-group="' + gi + '"][data-col]').forEach(function(cb) { cb.checked = gc.checked; });
          });
        });

        // Select All / Deselect All
        document.getElementById('export-select-all').addEventListener('click', function() {
          overlay.querySelectorAll('input[type="checkbox"]').forEach(function(cb) { cb.checked = true; });
        });
        document.getElementById('export-deselect-all').addEventListener('click', function() {
          overlay.querySelectorAll('input[type="checkbox"]').forEach(function(cb) { cb.checked = false; });
        });

        // Cancel
        document.getElementById('export-modal-cancel').addEventListener('click', function() { overlay.classList.remove('open'); });
        overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.classList.remove('open'); });

        // Confirm export
        document.getElementById('export-modal-confirm').addEventListener('click', function() {
          var selectedCols = [];
          for (var gi = 0; gi < groups.length; gi++) {
            for (var ci = 0; ci < groups[gi].columns.length; ci++) {
              var cb = overlay.querySelector('input[data-group="' + gi + '"][data-col="' + ci + '"]');
              if (cb && cb.checked) selectedCols.push(groups[gi].columns[ci]);
            }
          }
          overlay.classList.remove('open');
          if (selectedCols.length > 0) performExport(_exportItems, selectedCols);
        });

        overlay.classList.add('open');
      }

      function getExportCellValue(row, colKey) {
        if (colKey === '#') return String(row.index + 1);
        if (colKey === 'item_id') return row.item_id || String(row.index);
        if (colKey === 'status') return row.status || '';
        if (colKey === 'input') return stringify(row.input_full || row.input);
        if (colKey === 'expected') return stringify(row.expected_full || row.expected);
        if (colKey === 'output') return stringify(row.output_full || row.output);
        if (colKey === 'latency_ms') return String(row.latency_ms || '');
        if (colKey === 'trace_id') return row.trace_id || '';
        if (colKey === 'trace_url') return row.trace_url || buildLangfuseTraceUrl(row.trace_id) || '';

        if (colKey.startsWith('input.')) {
          var obj = tryParseObj(row.input_full || row.input);
          return obj ? stringify(obj[colKey.slice(6)]) : '';
        }
        if (colKey.startsWith('expected.')) {
          var obj = tryParseObj(row.expected_full || row.expected);
          return obj ? stringify(obj[colKey.slice(9)]) : '';
        }
        if (colKey.startsWith('output.')) {
          var obj = tryParseObj(row.output_full || row.output);
          return obj ? stringify(obj[colKey.slice(7)]) : '';
        }

        // meta:key
        if (colKey.startsWith('meta:')) {
          var k = colKey.slice(5);
          var md = row.item_metadata || {};
          var val = md[k];
          return val == null ? '' : (typeof val === 'object' ? JSON.stringify(val) : String(val));
        }

        // metric_score
        if (colKey.endsWith('_score')) {
          var m = colKey.slice(0, -6);
          var mi = state.allMetrics.indexOf(m);
          if (mi >= 0) return String((row.metric_values || [])[mi] ?? '');
          return '';
        }

        // metric:metakey
        var colonIdx = colKey.indexOf(':');
        if (colonIdx > 0) {
          var m = colKey.slice(0, colonIdx);
          var k = colKey.slice(colonIdx + 1);
          var mm = row.metric_meta || {};
          var meta = mm[m] || {};
          var val = meta[k];
          return val == null ? '' : (typeof val === 'object' ? JSON.stringify(val) : String(val));
        }

        return '';
      }

      function performExport(items, selectedCols) {
        var header = selectedCols.map(function(c) { return c.key; });
        var csvRows = [header.map(function(h) { return csvEscape(h); }).join(',')];
        for (var i = 0; i < items.length; i++) {
          var row = items[i].row;
          var r = selectedCols.map(function(c) { return csvEscape(getExportCellValue(row, c.key)); });
          csvRows.push(r.join(','));
        }
        var blob = new Blob(['\ufeff' + csvRows.join('\n')], { type: 'text/csv;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = (state.run?.run_name || 'run') + '_export.csv';
        a.click();
        URL.revokeObjectURL(url);
      }

      el('export-filtered-btn').addEventListener('click', function() {
        _exportItems = getFilteredItems();
        if (_exportItems.length === 0) return;
        var groups = discoverExportColumns(_exportItems);
        renderExportModal(groups);
      });

      // ── Auto-Analyze ──────────────────────────────────────────
      let _analyzeConfigCache = null;

      function initAnalyzePanel() {
          const runId = state.run?.file_path || state.run?.id;
          if (!runId) return;

          fetch(apiUrl('api/runs/' + encodeURIComponent(runId) + '/analysis-config'))
              .then(r => r.json())
              .then(config => {
                  _analyzeConfigCache = config;
                  // Wire up the auto-analyze button (added in renderSummary)
                  wireAnalyzeButton(config);
              })
              .catch(err => console.warn('Analysis config unavailable:', err));

          const closeBtn = el('analyze-panel-close');
          if (closeBtn) closeBtn.addEventListener('click', () => {
              el('analyze-panel').classList.remove('visible');
          });

          const runBtn = el('run-analysis-btn');
          if (runBtn) runBtn.addEventListener('click', runAnalysis);
      }

      function wireAnalyzeButton(config) {
          const btn = document.getElementById('auto-analyze-btn');
          if (!btn) return;
          if (!config.llm_configured) {
              btn.disabled = true;
              btn.title = 'LLM not configured — set it up in your Profile';
              btn.addEventListener('click', () => {
                  showToast('error', 'LLM Not Configured', 'Go to Profile → LLM Configuration to set up your provider.');
              });
          } else {
              btn.addEventListener('click', () => {
                  el('analyze-panel').classList.toggle('visible');
              });
          }
      }

      async function runAnalysis() {
          const runId = state.run?.file_path || state.run?.id;
          if (!runId) return;

          const btn = el('run-analysis-btn');
          btn.disabled = true;
          btn.textContent = 'Analyzing...';

          el('analyze-progress').classList.add('visible');
          el('analyze-progress-fill').style.width = '30%';
          el('analyze-results').style.display = 'none';

          const body = {
              metric: state.selectedMetric,
              item_filter: el('analyze-item-filter').value,
              max_score: parseFloat(el('analyze-max-score').value) || undefined,
              only_unanalyzed: el('analyze-only-new').checked,
              threshold: 0.8,
          };

          try {
              const res = await fetch(apiUrl('api/runs/' + encodeURIComponent(runId) + '/analyze'), {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(body),
              });
              el('analyze-progress-fill').style.width = '90%';
              const data = await res.json();

              if (!res.ok) {
                  showToast('error', 'Analysis Failed', data.detail || 'Unknown error');
                  return;
              }

              el('analyze-count').textContent = data.total_analyzed;
              el('analyze-progress-fill').style.width = '100%';

              // Update local state with new root causes
              const rows = state.snapshot?.rows || [];
              for (const result of (data.results || [])) {
                  const row = rows.find(r => r.item_id === result.item_id);
                  if (row) {
                      if (!row.item_metadata) row.item_metadata = {};
                      row.item_metadata.root_cause = result.root_cause;
                      row.item_metadata.root_cause_note = result.root_cause_note;
                      row.item_metadata.root_cause_source = 'ai';
                      row.item_metadata.root_cause_confidence = result.confidence;
                  }
              }

              // Show results summary
              el('analyze-results').style.display = 'block';
              el('analyze-results').innerHTML = '<div style="font-size:var(--font-sm);color:var(--text-secondary);padding:8px 0;">' +
                  'Analyzed <strong>' + data.total_analyzed + '</strong> items' +
                  (data.errors > 0 ? ' (<span style="color:#ef4444;">' + data.errors + ' errors</span>)' : '') +
                  '</div>';

              showToast('success', 'Analysis Complete', data.total_analyzed + ' items analyzed');

              // Re-render
              if (typeof renderMetadataBreakdown === 'function') renderMetadataBreakdown();
              if (typeof buildCategoryDropdowns === 'function') buildCategoryDropdowns();
              renderItems();
          } catch (err) {
              console.error('Analysis error:', err);
              showToast('error', 'Analysis Failed', err.message);
          } finally {
              btn.disabled = false;
              btn.innerHTML = '<span class="ai-icon">🤖</span> Run Analysis';
              setTimeout(() => {
                  el('analyze-progress').classList.remove('visible');
              }, 2000);
          }
      }

      // ── Initialize ──
      loadRunData();
    })();
  </script>
</body>
</html>
