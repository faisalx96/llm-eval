<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM-Eval • Profile</title>
  <link rel="stylesheet" href="./static/dashboard.css">
  <style>
    .profile-container {
      padding: var(--space-lg) var(--space-xl);
      overflow-y: auto;
      height: calc(100vh - 44px);
    }

    .section {
      margin-bottom: var(--space-xl);
    }

    .section-title {
      font-size: var(--font-sm);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-md);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--space-md);
    }

    .info-item {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      padding: var(--space-md);
    }

    .info-label {
      font-size: var(--font-xs);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 4px;
    }

    .info-value {
      font-size: var(--font-sm);
      color: var(--text-primary);
      font-family: var(--font-mono);
      word-break: break-word;
    }

    /* API Keys */
    .keys-section {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      overflow: hidden;
    }

    .keys-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--border-default);
    }

    .keys-header-title {
      font-size: var(--font-sm);
      font-weight: 600;
      color: var(--text-primary);
    }

    .keys-table {
      width: 100%;
      border-collapse: collapse;
    }

    .keys-table th {
      text-align: left;
      padding: var(--space-sm) var(--space-lg);
      font-size: var(--font-xs);
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border-default);
    }

    .keys-table td {
      padding: var(--space-md) var(--space-lg);
      font-size: var(--font-sm);
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-default);
    }

    .keys-table tr:last-child td {
      border-bottom: none;
    }

    .keys-table .key-name {
      color: var(--text-primary);
      font-weight: 500;
    }

    .keys-table .key-token {
      font-family: var(--font-mono);
      font-size: var(--font-xs);
      color: var(--text-muted);
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: var(--font-xs);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .status-badge.active {
      background: rgba(0, 212, 170, 0.15);
      color: var(--accent-primary);
    }

    .status-badge.revoked {
      background: rgba(255, 100, 100, 0.15);
      color: #ff6b6b;
    }

    .keys-table .key-actions {
      text-align: right;
    }

    .empty-state {
      padding: var(--space-xl);
      text-align: center;
      color: var(--text-muted);
      font-size: var(--font-sm);
    }

    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-default);
      background: var(--bg-elevated);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: var(--font-sm);
      font-weight: 500;
      transition: all 0.15s ease;
    }

    .btn.primary {
      border-color: rgba(0, 212, 170, 0.35);
      background: rgba(0, 212, 170, 0.12);
      color: var(--accent-primary);
    }

    .btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .btn.primary:hover {
      background: rgba(0, 212, 170, 0.18);
    }

    .btn.danger {
      border-color: rgba(255, 100, 100, 0.35);
      color: #ff6b6b;
    }

    .btn.danger:hover {
      background: rgba(255, 100, 100, 0.12);
    }

    .btn.sm, .btn.btn-sm {
      padding: 4px 10px;
      font-size: var(--font-xs);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .form-input {
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: 4px;
      padding: 8px 12px;
      color: var(--text-primary);
      font-size: var(--font-sm);
      outline: none;
      width: 100%;
      box-sizing: border-box;
    }

    .form-input:focus {
      border-color: var(--accent-primary);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .btn.copied {
      background: rgba(0, 212, 170, 0.2);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }

    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal-box {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 12px;
      padding: var(--space-xl);
      max-width: 420px;
      width: 90%;
    }

    .modal-header {
      margin-bottom: var(--space-lg);
    }

    .modal-title {
      font-size: var(--font-lg);
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .modal-subtitle {
      font-size: var(--font-sm);
      color: var(--text-muted);
      margin-top: var(--space-xs);
    }

    .modal-body {
      margin-bottom: var(--space-lg);
    }

    .form-group {
      margin-bottom: var(--space-md);
    }

    .form-label {
      display: block;
      font-size: var(--font-xs);
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: var(--space-xs);
    }

    .modal-footer {
      display: flex;
      gap: var(--space-sm);
      justify-content: flex-end;
    }

    /* Token Success State */
    .token-success {
      display: none;
    }

    .token-success.visible {
      display: block;
    }

    .token-warning {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      border-radius: 6px;
      margin-bottom: var(--space-md);
    }

    .token-warning-icon {
      font-size: 18px;
    }

    .token-warning-text {
      font-size: var(--font-sm);
      color: #ffc107;
    }

    .token-display {
      display: flex;
      gap: var(--space-sm);
      align-items: center;
    }

    .token-value {
      flex: 1;
      font-family: var(--font-mono);
      font-size: var(--font-sm);
      color: var(--text-primary);
      background: var(--bg-elevated);
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-default);
      word-break: break-all;
    }

    /* Confirm Dialog */
    .confirm-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .confirm-overlay.visible {
      display: flex;
    }

    .confirm-dialog {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: 8px;
      padding: var(--space-lg);
      max-width: 400px;
      width: 90%;
    }

    .confirm-title {
      font-size: var(--font-md);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-sm);
    }

    .confirm-message {
      font-size: var(--font-sm);
      color: var(--text-secondary);
      margin-bottom: var(--space-lg);
    }

    .confirm-actions {
      display: flex;
      gap: var(--space-sm);
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <header class="stats-bar">
    <div class="logo">
      <span class="logo-icon">◈</span>
      <span class="logo-text">LLM-EVAL</span>
    </div>
    <div class="stat-cells">
      <div class="stat-cell">
        <span class="stat-label">PAGE</span>
        <span class="stat-value">Profile</span>
      </div>
    </div>
    <div class="header-meta">
      <a class="header-btn" href="" id="back-link">← Dashboard</a>
    </div>
  </header>

  <main class="profile-container">
    <!-- Identity Section -->
    <div class="section">
      <div class="section-title">Identity</div>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Email</div>
          <div class="info-value" id="me-email">—</div>
        </div>
        <div class="info-item">
          <div class="info-label">Name</div>
          <div class="info-value" id="me-name">—</div>
        </div>
        <div class="info-item">
          <div class="info-label">Role</div>
          <div class="info-value" id="me-role">—</div>
        </div>
        <div class="info-item">
          <div class="info-label">Team</div>
          <div class="info-value" id="me-team">—</div>
        </div>
        <div class="info-item">
          <div class="info-label">Department</div>
          <div class="info-value" id="me-department">—</div>
        </div>
      </div>
    </div>

    <!-- API Keys Section -->
    <div class="section">
      <div class="section-title">API Keys</div>
      <div class="keys-section">
        <div class="keys-header">
          <div class="keys-header-title">Your API Keys</div>
          <button class="btn primary btn-sm" id="new-key-btn">+ New Key</button>
        </div>

        <div id="keys-container">
          <table class="keys-table" id="keys-table" style="display: none;">
            <thead>
              <tr>
                <th>Name</th>
                <th>Key</th>
                <th>Status</th>
                <th>Created</th>
                <th style="width: 80px;"></th>
              </tr>
            </thead>
            <tbody id="keys-tbody"></tbody>
          </table>
          <div class="empty-state" id="keys-empty">No API keys yet. Create one to get started.</div>
        </div>
      </div>
    </div>
  </main>

  <!-- Create API Key Modal -->
  <div class="modal-overlay" id="create-key-modal">
    <div class="modal-box">
      <!-- Create Form (initial state) -->
      <div id="create-form">
        <div class="modal-header">
          <h2 class="modal-title">Create API Key</h2>
          <p class="modal-subtitle">API keys are used to authenticate SDK requests</p>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label" for="key-name">Key Name</label>
            <input type="text" class="form-input" id="key-name" placeholder="e.g., dev-laptop, ci-pipeline">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" id="cancel-create-btn">Cancel</button>
          <button class="btn primary" id="confirm-create-btn">Create Key</button>
        </div>
      </div>

      <!-- Token Display (after creation) -->
      <div class="token-success" id="token-success">
        <div class="modal-header">
          <h2 class="modal-title">API Key Created</h2>
        </div>
        <div class="modal-body">
          <div class="token-warning">
            <span class="token-warning-icon">⚠</span>
            <span class="token-warning-text">Copy this key now — you won't be able to see it again</span>
          </div>
          <div class="token-display">
            <div class="token-value" id="token-value">—</div>
            <button class="btn primary" id="copy-token-btn">Copy</button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn primary" id="done-btn">Done</button>
        </div>
      </div>
    </div>
  </div>

  <div class="confirm-overlay" id="confirm-overlay">
    <div class="confirm-dialog">
      <div class="confirm-title" id="confirm-title">Confirm</div>
      <div class="confirm-message" id="confirm-message">Are you sure?</div>
      <div class="confirm-actions">
        <button class="btn" id="confirm-cancel-btn">Cancel</button>
        <button class="btn danger" id="confirm-ok-btn">Revoke</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      'use strict';

      const BASE_URL = (() => {
        const loc = window.location;
        let base = loc.pathname;
        if (!base.endsWith('/')) {
          base = base.substring(0, base.lastIndexOf('/') + 1) || '/';
        }
        return loc.origin + base;
      })();

      function apiUrl(path) {
        const cleanPath = String(path || '').replace(/^\.?\//, '');
        return BASE_URL + cleanPath;
      }

      const el = (id) => document.getElementById(id);
      const back = el('back-link');
      if (back) back.href = apiUrl('');

      function formatDate(isoStr) {
        if (!isoStr) return '—';
        const d = new Date(isoStr);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      async function loadMe() {
        const res = await fetch(apiUrl('v1/me'));
        if (!res.ok) throw new Error('Failed to load /v1/me');
        const me = await res.json();

        el('me-email').textContent = me.email || '—';
        el('me-name').textContent = me.display_name || '—';
        el('me-role').textContent = me.role || '—';
        el('me-team').textContent = me.team?.name || '—';
        el('me-department').textContent = me.department?.name || '—';
      }

      async function loadKeys() {
        const res = await fetch(apiUrl('v1/me/api-keys'));
        if (!res.ok) throw new Error('Failed to load API keys');
        const data = await res.json();
        renderKeys(data.api_keys || []);
      }

      function renderKeys(keys) {
        const table = el('keys-table');
        const tbody = el('keys-tbody');
        const empty = el('keys-empty');

        if (keys.length === 0) {
          table.style.display = 'none';
          empty.style.display = 'block';
          return;
        }

        table.style.display = 'table';
        empty.style.display = 'none';
        tbody.innerHTML = keys.map(k => {
          const isRevoked = !!k.revoked_at;
          return `
            <tr>
              <td class="key-name">${escapeHtml(k.name || 'Unnamed')}</td>
              <td class="key-token">${escapeHtml(k.prefix)}••••••••</td>
              <td><span class="status-badge ${isRevoked ? 'revoked' : 'active'}">${isRevoked ? 'Revoked' : 'Active'}</span></td>
              <td>${formatDate(k.created_at)}</td>
              <td class="key-actions">${isRevoked ? '' : `<button class="btn btn-sm danger revoke-btn" data-id="${k.id}">Revoke</button>`}</td>
            </tr>
          `;
        }).join('');

        tbody.querySelectorAll('.revoke-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            showConfirm('Revoke API Key', 'This key will stop working immediately. This cannot be undone.', () => revokeKey(id));
          });
        });
      }

      function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      const confirmOverlay = el('confirm-overlay');
      let confirmCallback = null;

      function showConfirm(title, message, onConfirm) {
        el('confirm-title').textContent = title;
        el('confirm-message').textContent = message;
        confirmCallback = onConfirm;
        confirmOverlay.classList.add('visible');
      }

      function hideConfirm() {
        confirmOverlay.classList.remove('visible');
        confirmCallback = null;
      }

      el('confirm-cancel-btn').addEventListener('click', hideConfirm);
      el('confirm-ok-btn').addEventListener('click', async () => {
        if (confirmCallback) await confirmCallback();
        hideConfirm();
      });
      confirmOverlay.addEventListener('click', (e) => {
        if (e.target === confirmOverlay) hideConfirm();
      });

      async function revokeKey(id) {
        const res = await fetch(apiUrl(`v1/me/api-keys/${id}`), { method: 'DELETE' });
        if (!res.ok) {
          alert('Failed to revoke: ' + await res.text());
          return;
        }
        await loadKeys();
      }

      const createModal = el('create-key-modal');
      const createForm = el('create-form');
      const tokenSuccess = el('token-success');
      const newKeyBtn = el('new-key-btn');

      function showCreateModal() {
        createForm.style.display = 'block';
        tokenSuccess.classList.remove('visible');
        createModal.classList.add('visible');
        el('key-name').value = '';
        setTimeout(() => el('key-name').focus(), 100);
      }

      function hideCreateModal() {
        createModal.classList.remove('visible');
        createForm.style.display = 'block';
        tokenSuccess.classList.remove('visible');
      }

      newKeyBtn.addEventListener('click', showCreateModal);
      el('cancel-create-btn').addEventListener('click', hideCreateModal);
      createModal.addEventListener('click', (e) => {
        if (e.target === createModal) hideCreateModal();
      });

      el('done-btn').addEventListener('click', () => {
        hideCreateModal();
        loadKeys();
      });

      el('confirm-create-btn').addEventListener('click', async () => {
        const name = (el('key-name').value || 'default').trim();
        const scopes = ['runs:write', 'runs:read'];
        const btn = el('confirm-create-btn');
        btn.disabled = true;
        btn.textContent = 'Creating...';

        try {
          const res = await fetch(apiUrl('v1/me/api-keys'), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, scopes }),
          });
          if (!res.ok) throw new Error(await res.text() || 'Create failed');
          const data = await res.json();

          createForm.style.display = 'none';
          tokenSuccess.classList.add('visible');
          el('token-value').textContent = data.token || '—';
          el('copy-token-btn').textContent = 'Copy';
          el('copy-token-btn').classList.remove('copied');
        } catch (err) {
          alert('Failed to create API key: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Create Key';
        }
      });

      el('copy-token-btn').addEventListener('click', async () => {
        const text = el('token-value').textContent || '';
        const btn = el('copy-token-btn');
        try {
          await navigator.clipboard.writeText(text);
          btn.classList.add('copied');
          btn.textContent = 'Copied!';
          setTimeout(() => {
            btn.classList.remove('copied');
            btn.textContent = 'Copy';
          }, 2000);
        } catch {
          window.prompt('Copy this token:', text);
        }
      });

      Promise.all([loadMe(), loadKeys()]).catch(err => {
        console.error(err);
        showAuthError();
      });

      function showAuthError() {
        document.querySelector('.profile-container').innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: calc(100vh - 100px);">
            <div style="text-align: center; max-width: 360px; padding: 40px;">
              <div style="font-size: 64px; margin-bottom: 24px;">◈</div>
              <h1 style="font-size: 24px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">LLM-Eval Platform</h1>
              <p style="color: var(--text-muted); margin-bottom: 32px;">Sign in to access your profile</p>

              <button onclick="location.reload()" style="width: 100%; padding: 12px 24px; background: var(--accent-primary); color: var(--bg-base); border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                Sign in with SSO
              </button>
            </div>
          </div>
        `;
      }
    })();
  </script>
</body>
</html>
